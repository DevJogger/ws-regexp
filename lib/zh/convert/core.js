"use strict";
/**
 * Created by user on 2018/8/2/002.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const array_hyper_unique_1 = require("array-hyper-unique");
const UString = require("uni-string");
const cjk_conv_1 = require("regexp-helper/lib/cjk-conv");
function charMap(s, table) {
    let t = table[s];
    return (typeof t === 'string') ? t : s;
}
exports.charMap = charMap;
function textMap1(text, table) {
    let toText = [];
    let len = text.length;
    for (let i = 0; i < len; i++) {
        toText[i] = charMap(text[i], table);
    }
    //console.log(toText.length, toText);
    return toText.join('');
}
exports.textMap1 = textMap1;
function textMap2(text, table) {
    let toText = UString.split(text, '');
    let len = toText.length;
    for (let i = 0; i < len; i++) {
        toText[i] = charMap(toText[i], table);
    }
    //console.log(toText.length, toText);
    return toText.join('');
}
exports.textMap2 = textMap2;
function textMap3(text, table) {
    let toText = text.split(/(?:)/u);
    let len = toText.length;
    for (let i = 0; i < len; i++) {
        toText[i] = charMap(toText[i], table);
    }
    //console.log(toText.length, toText);
    return toText.join('');
}
exports.textMap3 = textMap3;
function textMap4(text, table) {
    return text.replace(exports.REGEXP_TEST, function (s) {
        return charMap(s, table);
    });
}
exports.textMap4 = textMap4;
exports.textMap = textMap4;
const textMap = textMap4;
exports.default = exports;
function removeSame(table) {
    return Object.entries(table)
        .reduce(function (a, b) {
        let [k, v] = b;
        if (k != v) {
            a[k] = v;
        }
        return a;
    }, {});
}
exports.removeSame = removeSame;
exports.defaultOptions = Object.freeze({
    safe: true,
});
exports.REGEXP_TEST = cjk_conv_1._re_cjk_conv('ug');
exports.SAFE_MODE_CHAR = array_hyper_unique_1.array_unique([
    '后',
    '里',
    '餵',
    '志',
    '布',
    '佈',
    '系',
    '繫',
    '梁',
    '樑',
    '衝',
    '沖',
    '谷',
    '穀',
]);
function getOptionsSkip(options, skip = exports.SAFE_MODE_CHAR) {
    if (!options.skip) {
        options.skip = skip.slice();
    }
    else if (typeof options.skip == 'string') {
        options.skip += skip.join('');
    }
    else if (Array.isArray(options.skip)) {
        options.skip = options.skip.slice().concat(skip);
    }
    else {
        options.table = skip.reduce(function (a, b) {
            a[b] = b;
            return a;
        }, Object.assign({}, options.table || {}));
    }
    return options;
}
exports.getOptionsSkip = getOptionsSkip;
function getOptions(options = {}, defaultOpts = exports.defaultOptions, skip = exports.SAFE_MODE_CHAR) {
    options = Object.assign({}, defaultOpts, options);
    if (options.safe) {
        options = getOptionsSkip(options, skip);
        //console.log(options);
    }
    return options;
}
exports.getOptions = getOptions;
function _call(fn, text, options = {}, ...argv) {
    options = getOptions(options);
    if (options.skip || options.table || options.tableOnly) {
        let { skip, table, tableOnly } = options;
        let not_tableOnly = !tableOnly;
        if (tableOnly && !table) {
            throw new Error(`table is ${table}`);
        }
        return text.replace(exports.REGEXP_TEST, function (text) {
            if (skip && skip.indexOf(text) !== -1) {
                return text;
            }
            else if (table && typeof table == 'function') {
                let ret = table(fn, text, options, ...argv);
                if (ret !== null && typeof ret != 'undefined') {
                    return ret;
                }
            }
            else if (table && table[text]) {
                return table[text];
            }
            else if (not_tableOnly) {
                return fn(text);
            }
            return text;
        });
    }
    return fn(text, options, ...argv);
}
exports._call = _call;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUVILDJEQUFrRDtBQUdsRCxzQ0FBdUM7QUFDdkMseURBQTBEO0FBTzFELFNBQWdCLE9BQU8sQ0FBQyxDQUFTLEVBQUUsS0FBYTtJQUUvQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUN2QyxDQUFDO0FBSkQsMEJBSUM7QUFFRCxTQUFnQixRQUFRLENBQUMsSUFBWSxFQUFFLEtBQWE7SUFFbkQsSUFBSSxNQUFNLEdBQUcsRUFBRSxDQUFDO0lBQ2hCLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7SUFFdEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFDNUI7UUFDQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztLQUNwQztJQUVELHFDQUFxQztJQUNyQyxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7QUFDdkIsQ0FBQztBQVpELDRCQVlDO0FBRUQsU0FBZ0IsUUFBUSxDQUFDLElBQVksRUFBRSxLQUFhO0lBRW5ELElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3JDLElBQUksR0FBRyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFFeEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFDNUI7UUFDQyxN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QUM7U0FDckM7UUFFRCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsbUJBQVcsRUFBRSxVQUFVLElBQUk7WUFFOUMsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFDckM7Z0JBQ0MsT0FBTyxJQUFJLENBQUM7YUFDWjtpQkFDSSxJQUFJLEtBQUssSUFBSSxPQUFPLEtBQUssSUFBSSxVQUFVLEVBQzVDO2dCQUNDLElBQUksR0FBRyxHQUFHLEtBQUssQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO2dCQUU1QyxJQUFJLEdBQUcsS0FBSyxJQUFJLElBQUksT0FBTyxHQUFHLElBQUksV0FBVyxFQUM3QztvQkFDQyxPQUFPLEdBQUcsQ0FBQztpQkFDWDthQUNEO2lCQUNJLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFDN0I7Z0JBQ0MsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDbkI7aUJBQ0ksSUFBSSxhQUFhLEVBQ3RCO2dCQUNDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2hCO1lBRUQsT0FBTyxJQUFJLENBQUM7UUFDYixDQUFDLENBQUMsQ0FBQztLQUNIO0lBRUQsT0FBTyxFQUFFLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO0FBQ25DLENBQUM7QUEzQ0Qsc0JBMkNDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjAxOC84LzIvMDAyLlxuICovXG5cbmltcG9ydCB7IGFycmF5X3VuaXF1ZSB9IGZyb20gJ2FycmF5LWh5cGVyLXVuaXF1ZSc7XG5pbXBvcnQgKiBhcyBfdGFibGVfY24ydHcgZnJvbSAnY2hpbmVzZV9jb252ZXJ0L2NuMnR3JztcbmltcG9ydCAqIGFzIF90YWJsZV90dzJjbiBmcm9tICdjaGluZXNlX2NvbnZlcnQvdHcyY24nO1xuaW1wb3J0IFVTdHJpbmcgPSByZXF1aXJlKCd1bmktc3RyaW5nJyk7XG5pbXBvcnQgeyBfcmVfY2prX2NvbnYgfSBmcm9tICdyZWdleHAtaGVscGVyL2xpYi9jamstY29udic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVRhYmxlXG57XG5cdFtrZXk6IHN0cmluZ106IHN0cmluZyxcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNoYXJNYXAoczogc3RyaW5nLCB0YWJsZTogSVRhYmxlKVxue1xuXHRsZXQgdCA9IHRhYmxlW3NdO1xuXHRyZXR1cm4gKHR5cGVvZiB0ID09PSAnc3RyaW5nJykgPyB0IDogc1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdGV4dE1hcDEodGV4dDogc3RyaW5nLCB0YWJsZTogSVRhYmxlKVxue1xuXHRsZXQgdG9UZXh0ID0gW107XG5cdGxldCBsZW4gPSB0ZXh0Lmxlbmd0aDtcblxuXHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKVxuXHR7XG5cdFx0dG9UZXh0W2ldID0gY2hhck1hcCh0ZXh0W2ldLCB0YWJsZSk7XG5cdH1cblxuXHQvL2NvbnNvbGUubG9nKHRvVGV4dC5sZW5ndGgsIHRvVGV4dCk7XG5cdHJldHVybiB0b1RleHQuam9pbignJylcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRleHRNYXAyKHRleHQ6IHN0cmluZywgdGFibGU6IElUYWJsZSlcbntcblx0bGV0IHRvVGV4dCA9IFVTdHJpbmcuc3BsaXQodGV4dCwgJycpO1xuXHRsZXQgbGVuID0gdG9UZXh0Lmxlbmd0aDtcblxuXHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKVxuXHR7XG5cdFx0dG9UZXh0W2ldID0gY2hhck1hcCh0b1RleHRbaV0sIHRhYmxlKTtcblx0fVxuXG5cdC8vY29uc29sZS5sb2codG9UZXh0Lmxlbmd0aCwgdG9UZXh0KTtcblx0cmV0dXJuIHRvVGV4dC5qb2luKCcnKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRleHRNYXAzKHRleHQ6IHN0cmluZywgdGFibGU6IElUYWJsZSlcbntcblx0bGV0IHRvVGV4dCA9IHRleHQuc3BsaXQoLyg/OikvdSk7XG5cdGxldCBsZW4gPSB0b1RleHQubGVuZ3RoO1xuXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspXG5cdHtcblx0XHR0b1RleHRbaV0gPSBjaGFyTWFwKHRvVGV4dFtpXSwgdGFibGUpO1xuXHR9XG5cblx0Ly9jb25zb2xlLmxvZyh0b1RleHQubGVuZ3RoLCB0b1RleHQpO1xuXHRyZXR1cm4gdG9UZXh0LmpvaW4oJycpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdGV4dE1hcDQodGV4dDogc3RyaW5nLCB0YWJsZTogSVRhYmxlKVxue1xuXHRyZXR1cm4gdGV4dC5yZXBsYWNlKFJFR0VYUF9URVNULCBmdW5jdGlvbiAocylcblx0e1xuXHRcdHJldHVybiBjaGFyTWFwKHMsIHRhYmxlKTtcblx0fSk7XG59XG5cbmV4cG9ydCB7IHRleHRNYXA0IGFzIHRleHRNYXAgfVxuY29uc3QgdGV4dE1hcCA9IHRleHRNYXA0O1xuXG5leHBvcnQgZGVmYXVsdCBleHBvcnRzIGFzIHR5cGVvZiBpbXBvcnQoJy4vY29yZScpO1xuXG5leHBvcnQgZnVuY3Rpb24gcmVtb3ZlU2FtZSh0YWJsZTogSVRhYmxlKVxue1xuXHRyZXR1cm4gT2JqZWN0LmVudHJpZXModGFibGUpXG5cdFx0LnJlZHVjZShmdW5jdGlvbiAoYSwgYilcblx0XHR7XG5cdFx0XHRsZXQgW2ssIHZdID0gYjtcblxuXHRcdFx0aWYgKGsgIT0gdilcblx0XHRcdHtcblx0XHRcdFx0YVtrXSA9IHY7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBhO1xuXHRcdH0sIHt9IGFzIElUYWJsZSlcblx0O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElPcHRpb25zXG57XG5cdC8qKlxuXHQgKiDlv73nlaXnmoTlrZcgb3Ig5Lu75L2V5pSv5o+0IGluZGV4T2Yg55qEIE9iamVjdFxuXHQgKi9cblx0c2tpcD8sXG5cblx0dGFibGU/OiBJVGFibGUgfCB0eXBlb2YgX2NhbGwsXG5cblx0c2FmZT86IGJvb2xlYW4sXG5cblx0dGFibGVPbmx5PzogYm9vbGVhbixcbn1cblxuZXhwb3J0IGNvbnN0IGRlZmF1bHRPcHRpb25zID0gT2JqZWN0LmZyZWV6ZSh7XG5cdHNhZmU6IHRydWUsXG59KTtcbmV4cG9ydCBjb25zdCBSRUdFWFBfVEVTVCA9IF9yZV9jamtfY29udigndWcnKTtcblxuZXhwb3J0IGNvbnN0IFNBRkVfTU9ERV9DSEFSID0gYXJyYXlfdW5pcXVlKFtcblx0J+WQjicsXG5cdCfph4wnLFxuXHQn6aS1Jyxcblx0J+W/lycsXG5cdCfluIMnLFxuXHQn5L2IJyxcblx0J+ezuycsXG5cdCfnuasnLFxuXHQn5qKBJyxcblx0J+aokScsXG5cdCfooZ0nLFxuXHQn5rKWJyxcblx0J+iwtycsXG5cdCfnqYAnLFxuXSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRPcHRpb25zU2tpcChvcHRpb25zOiBJT3B0aW9ucywgc2tpcCA9IFNBRkVfTU9ERV9DSEFSKVxue1xuXHRpZiAoIW9wdGlvbnMuc2tpcClcblx0e1xuXHRcdG9wdGlvbnMuc2tpcCA9IHNraXAuc2xpY2UoKTtcblx0fVxuXHRlbHNlIGlmICh0eXBlb2Ygb3B0aW9ucy5za2lwID09ICdzdHJpbmcnKVxuXHR7XG5cdFx0b3B0aW9ucy5za2lwICs9IHNraXAuam9pbignJyk7XG5cdH1cblx0ZWxzZSBpZiAoQXJyYXkuaXNBcnJheShvcHRpb25zLnNraXApKVxuXHR7XG5cdFx0b3B0aW9ucy5za2lwID0gb3B0aW9ucy5za2lwLnNsaWNlKCkuY29uY2F0KHNraXApO1xuXHR9XG5cdGVsc2Vcblx0e1xuXHRcdG9wdGlvbnMudGFibGUgPSBza2lwLnJlZHVjZShmdW5jdGlvbiAoYSwgYilcblx0XHR7XG5cdFx0XHRhW2JdID0gYjtcblxuXHRcdFx0cmV0dXJuIGE7XG5cdFx0fSwgT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucy50YWJsZSB8fCB7fSkpO1xuXHR9XG5cblx0cmV0dXJuIG9wdGlvbnM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRPcHRpb25zKG9wdGlvbnM6IElPcHRpb25zID0ge30sIGRlZmF1bHRPcHRzID0gZGVmYXVsdE9wdGlvbnMsIHNraXAgPSBTQUZFX01PREVfQ0hBUilcbntcblx0b3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRPcHRzLCBvcHRpb25zKTtcblxuXHRpZiAob3B0aW9ucy5zYWZlKVxuXHR7XG5cdFx0b3B0aW9ucyA9IGdldE9wdGlvbnNTa2lwKG9wdGlvbnMsIHNraXApO1xuXG5cdFx0Ly9jb25zb2xlLmxvZyhvcHRpb25zKTtcblx0fVxuXG5cdHJldHVybiBvcHRpb25zO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX2NhbGwoZm4sIHRleHQ6IHN0cmluZywgb3B0aW9uczogSU9wdGlvbnMgPSB7fSwgLi4uYXJndilcbntcblx0b3B0aW9ucyA9IGdldE9wdGlvbnMob3B0aW9ucyk7XG5cblx0aWYgKG9wdGlvbnMuc2tpcCB8fCBvcHRpb25zLnRhYmxlIHx8IG9wdGlvbnMudGFibGVPbmx5KVxuXHR7XG5cdFx0bGV0IHsgc2tpcCwgdGFibGUsIHRhYmxlT25seSB9ID0gb3B0aW9ucztcblx0XHRsZXQgbm90X3RhYmxlT25seSA9ICF0YWJsZU9ubHk7XG5cblx0XHRpZiAodGFibGVPbmx5ICYmICF0YWJsZSlcblx0XHR7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYHRhYmxlIGlzICR7dGFibGV9YCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRleHQucmVwbGFjZShSRUdFWFBfVEVTVCwgZnVuY3Rpb24gKHRleHQpXG5cdFx0e1xuXHRcdFx0aWYgKHNraXAgJiYgc2tpcC5pbmRleE9mKHRleHQpICE9PSAtMSlcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIHRleHQ7XG5cdFx0XHR9XG5cdFx0XHRlbHNlIGlmICh0YWJsZSAmJiB0eXBlb2YgdGFibGUgPT0gJ2Z1bmN0aW9uJylcblx0XHRcdHtcblx0XHRcdFx0bGV0IHJldCA9IHRhYmxlKGZuLCB0ZXh0LCBvcHRpb25zLCAuLi5hcmd2KTtcblxuXHRcdFx0XHRpZiAocmV0ICE9PSBudWxsICYmIHR5cGVvZiByZXQgIT0gJ3VuZGVmaW5lZCcpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRyZXR1cm4gcmV0O1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRlbHNlIGlmICh0YWJsZSAmJiB0YWJsZVt0ZXh0XSlcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIHRhYmxlW3RleHRdO1xuXHRcdFx0fVxuXHRcdFx0ZWxzZSBpZiAobm90X3RhYmxlT25seSlcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIGZuKHRleHQpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gdGV4dDtcblx0XHR9KTtcblx0fVxuXG5cdHJldHVybiBmbih0ZXh0LCBvcHRpb25zLCAuLi5hcmd2KTtcbn1cbiJdfQ==