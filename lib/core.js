"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const conv_1 = require("./conv");
const regexp_parser_literal_1 = require("regexp-parser-literal");
const regexp_parser_event_1 = require("regexp-parser-event");
exports.ParserEventEmitter = regexp_parser_event_1.ParserEventEmitter;
exports.ParserEventEmitterEvent = regexp_parser_event_1.ParserEventEmitterEvent;
const regexp_range_1 = require("regexp-range");
const zhTable = require("cjk-conv/lib/zh/table/index");
function coreHandler(str, flags = null, options = {}, ...argv) {
    if (flags !== null && typeof flags == 'object') {
        options = Object.assign({}, flags);
        flags = options.flags || null;
    }
    if (typeof options == 'string') {
        options = {
            skip: options,
        };
    }
    if (typeof options.flags == 'string') {
        flags = options.flags;
    }
    let hasFlags = typeof flags == 'string';
    options = fixOptionsOn(options);
    if (1 && (!options.disableZh || !options.disableLocalRange || options.on)) {
        let ev;
        const zhTableFn = options.zhTable || (options.greedyTable ? conv_1.zhTableAutoGreedyTable : zhTable.auto);
        if (str instanceof RegExp) {
            let ast = regexp_parser_literal_1.parseRegExp(str.toString());
            // @ts-ignore
            ev = new regexp_parser_event_1.ParserEventEmitter(ast);
        }
        else {
            if (options.parseRegularExpressionString && typeof str == 'string') {
                let m = parseRegularExpressionString(str);
                if (m) {
                    str = m.source;
                    flags = hasFlags ? flags : m.flags;
                }
            }
            ev = regexp_parser_event_1.ParserEventEmitter.create(str, flags || '');
        }
        if (!options.disableZh) {
            ev.on(regexp_parser_event_1.ParserEventEmitterEvent.default, function (ast) {
                ast.old_raw = ast.old_raw || ast.raw;
                let raw = conv_1._word_zh_core(ast.raw, options.skip, zhTableFn, options);
                if (ast.raw !== raw) {
                    ast.raw = raw;
                    ev.emit(regexp_parser_event_1.ParserEventEmitterEvent.change, ast);
                }
            });
        }
        if (!options.disableLocalRange) {
            ev.on(regexp_parser_event_1.ParserEventEmitterEvent.class_range, function (ast, ...argv) {
                let s = ast.min.raw;
                let e = ast.max.raw;
                let ret = regexp_range_1.default(s, e, {
                    createRegExpString: true,
                });
                if (ret) {
                    if (options.allowLocalRangeAutoZh) {
                        ret = conv_1._word_zh_core2(ret, options.skip, zhTableFn, options);
                    }
                    ast.old_raw = ast.old_raw || ast.raw;
                    if (ast.raw !== ret) {
                        ast.raw = ret;
                        ev.emit(regexp_parser_event_1.ParserEventEmitterEvent.change, ast);
                    }
                }
            });
        }
        setupParserEventEmitter(ev, options);
        ev.resume();
        str = ev.getSource(!!options.debugChanged
            || !options.noUniqueClass
            || options.sortClass, options);
        flags = hasFlags ? flags : ev.flags;
    }
    else {
        if (options.parseRegularExpressionString && typeof str == 'string') {
            let m = parseRegularExpressionString(str);
            if (m) {
                str = new RegExp(m.source, m.flags);
                flags = hasFlags ? flags : str.flags;
            }
        }
        else if (str instanceof RegExp) {
            str = str.source;
            flags = hasFlags ? flags : str.flags;
        }
    }
    return {
        source: str,
        flags: flags || '',
        options: options,
    };
}
exports.coreHandler = coreHandler;
function parseRegularExpressionString(str) {
    let m = /^([\/#$%])(.+?)\1([a-z]*)$/.exec(str);
    if (m) {
        let [s, d, r, f] = m;
        return {
            source: typeof r !== 'undefined' ? r : '',
            flags: typeof f !== 'undefined' ? f : '',
            slash: s,
            input: str,
        };
    }
    return null;
}
exports.parseRegularExpressionString = parseRegularExpressionString;
function fixOptionsOn(options) {
    if (options.on && !Array.isArray(options.on)) {
        options.on = [options.on];
    }
    // @ts-ignore
    return options;
}
exports.fixOptionsOn = fixOptionsOn;
function setupParserEventEmitter(ev, options) {
    if (options.on) {
        fixOptionsOn(options).on
            .forEach((conf) => {
            Object
                .keys(conf)
                .forEach(function (event) {
                ev.on(event, options.on[event]);
            });
        });
    }
    return ev;
}
exports.setupParserEventEmitter = setupParserEventEmitter;
exports.default = coreHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpQ0FBK0U7QUFDL0UsaUVBQXlFO0FBQ3pFLDZEQUs2QjtBQU1LLDZCQVRqQyx3Q0FBa0IsQ0FTaUM7QUFBM0Msa0NBUlIsNkNBQXVCLENBUVE7QUFMaEMsK0NBQXVDO0FBQ3ZDLHVEQUF3RDtBQStEeEQsU0FBZ0IsV0FBVyxDQUFDLEdBQUcsRUFBRSxLQUFLLEdBQUcsSUFBSSxFQUFFLFVBQWtDLEVBQUUsRUFBRSxHQUFHLElBQUk7SUFFM0YsSUFBSSxLQUFLLEtBQUssSUFBSSxJQUFJLE9BQU8sS0FBSyxJQUFJLFFBQVEsRUFDOUM7UUFDQyxPQUFPLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFhLENBQUM7UUFDL0MsS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDO0tBQzlCO0lBRUQsSUFBSSxPQUFPLE9BQU8sSUFBSSxRQUFRLEVBQzlCO1FBQ0MsT0FBTyxHQUFHO1lBQ1QsSUFBSSxFQUFFLE9BQU87U0FDRCxDQUFDO0tBQ2Q7SUFFRCxJQUFJLE9BQU8sT0FBTyxDQUFDLEtBQUssSUFBSSxRQUFRLEVBQ3BDO1FBQ0MsS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUM7S0FDdEI7SUFFRCxJQUFJLFFBQVEsR0FBRyxPQUFPLEtBQUssSUFBSSxRQUFRLENBQUM7SUFFeEMsT0FBTyxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUVoQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsSUFBSSxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQ3pFO1FBQ0MsSUFBSSxFQUFzQixDQUFDO1FBRTNCLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxD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dGVudCI6WyJpbXBvcnQgeyBfd29yZF96aF9jb3JlLCBfd29yZF96aF9jb3JlMiwgemhUYWJsZUF1dG9HcmVlZHlUYWJsZSB9IGZyb20gJy4vY29udic7XG5pbXBvcnQgeyBJQXN0VG9TdHJpbmdPcHRpb25zLCBwYXJzZVJlZ0V4cCB9IGZyb20gJ3JlZ2V4cC1wYXJzZXItbGl0ZXJhbCc7XG5pbXBvcnQge1xuXHRJUGFyc2VyRXZlbnRFbWl0dGVyTGlzdGVuZXIsXG5cdFBhcnNlckV2ZW50RW1pdHRlcixcblx0UGFyc2VyRXZlbnRFbWl0dGVyRXZlbnQsXG5cdElOb2RlSW5wdXQsXG59IGZyb20gJ3JlZ2V4cC1wYXJzZXItZXZlbnQnO1xuaW1wb3J0IHJlZ2V4cFJhbmdlIGZyb20gJ3JlZ2V4cC1yYW5nZSc7XG5pbXBvcnQgemhUYWJsZSA9IHJlcXVpcmUoJ2Nqay1jb252L2xpYi96aC90YWJsZS9pbmRleCcpO1xuaW1wb3J0IHsgaXNSZWdFeHAgfSBmcm9tICdyZWdleHAtaGVscGVyJztcbmltcG9ydCB7IElPcHRpb25zIGFzIElPcHRpb25zWmhUYWJsZSB9IGZyb20gJ2Nqay1jb252L2xpYi96aC90YWJsZS9pbmRleCc7XG5cbmV4cG9ydCB7IFBhcnNlckV2ZW50RW1pdHRlckV2ZW50LCBQYXJzZXJFdmVudEVtaXR0ZXIsIElOb2RlSW5wdXQsIElQYXJzZXJFdmVudEVtaXR0ZXJMaXN0ZW5lciwgSUFzdFRvU3RyaW5nT3B0aW9ucyB9XG5cbmV4cG9ydCB7IElPcHRpb25zWmhUYWJsZSB9XG5cbmV4cG9ydCB0eXBlIElPcHRpb25zQ29yZSA9IHtcblx0c2tpcD86IHN0cmluZyxcblx0ZGlzYWJsZVpoPzogYm9vbGVhbixcblx0LyoqXG5cdCAqIGRpc2FibGVMb2NhbFJhbmdlIG9ubHkgd29yayB3aGVuIGRpc2FibGVaaCBpcyB0cnVlXG5cdCAqL1xuXHRkaXNhYmxlTG9jYWxSYW5nZT86IGJvb2xlYW4sXG5cdGFsbG93TG9jYWxSYW5nZUF1dG9aaD86IGJvb2xlYW4sXG5cdGZsYWdzPzogc3RyaW5nLFxuXG5cdC8qKlxuXHQgKiBhbGxvdyBzdHIgaXMgL2EvZ1xuXHQgKi9cblx0cGFyc2VSZWd1bGFyRXhwcmVzc2lvblN0cmluZz86IGJvb2xlYW4sXG5cblx0LyoqXG5cdCAqIOiukyDmloflrZfmr5TlsI0g5pu05Yqg5a+s6ayGXG5cdCAqL1xuXHRncmVlZHlUYWJsZT86IGJvb2xlYW4gfCBudW1iZXIsXG5cdHVuc2FmZT86IGJvb2xlYW4sXG5cblx0LyoqXG5cdCAqIGFsbG93IHNldCBgQ2prQ29udi56aFRhYmxlLmF1dG9gXG5cdCAqL1xuXHR6aFRhYmxlPyhjaGFyOiBzdHJpbmcsIG9wdGlvbnM/OiBJT3B0aW9uc1poVGFibGUpOiBzdHJpbmdbXVxuXG59ICYgSUFzdFRvU3RyaW5nT3B0aW9ucztcblxuZXhwb3J0IHR5cGUgSU9wdGlvbnM8VCBleHRlbmRzIElOb2RlSW5wdXQgPSBJTm9kZUlucHV0PiA9IElPcHRpb25zQ29yZSAmIHtcblx0b24/OiBJT3B0aW9uc09uPFQ+IHwgSU9wdGlvbnNPbjxUPltdLFxufVxuXG5leHBvcnQgdHlwZSBJT3B0aW9uc1J1bnRpbWU8VCBleHRlbmRzIElOb2RlSW5wdXQgPSBJTm9kZUlucHV0PiA9IElPcHRpb25zQ29yZSAmIHtcblx0b24/OiBJT3B0aW9uc09uPFQ+W10sXG59XG5cbmV4cG9ydCB0eXBlIElPcHRpb25zSW5wdXQ8VCBleHRlbmRzIElOb2RlSW5wdXQgPSBJTm9kZUlucHV0PiA9IElPcHRpb25zPFQ+IHwgSU9wdGlvbnNSdW50aW1lPFQ+XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNvcmVIYW5kbGVyUmV0dXJuPFQgZXh0ZW5kcyBJTm9kZUlucHV0ID0gSU5vZGVJbnB1dD5cbntcblx0c291cmNlOiBzdHJpbmcsXG5cdGZsYWdzOiBzdHJpbmcsXG5cdG9wdGlvbnM6IElPcHRpb25zUnVudGltZTxUPixcbn1cblxuZXhwb3J0IHR5cGUgSU9wdGlvbnNPbjxUIGV4dGVuZHMgSU5vZGVJbnB1dCA9IElOb2RlSW5wdXQ+ID0ge1xuXHRbayBpbiBQYXJzZXJFdmVudEVtaXR0ZXJFdmVudF0/OiBJUGFyc2VyRXZlbnRFbWl0dGVyTGlzdGVuZXI8VCwgUGFyc2VyRXZlbnRFbWl0dGVyRXZlbnQ+O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY29yZUhhbmRsZXIoc3RyOiBzdHJpbmcgfCBSZWdFeHAsXG5cdGZsYWdzPzogc3RyaW5nLFxuXHRvcHRpb25zPzogSU9wdGlvbnNJbnB1dCB8IHN0cmluZyxcblx0Li4uYXJndlxuKTogSUNvcmVIYW5kbGVyUmV0dXJuXG5leHBvcnQgZnVuY3Rpb24gY29yZUhhbmRsZXIoc3RyOiBzdHJpbmcgfCBSZWdFeHAsIG9wdGlvbnM/OiBJT3B0aW9uc0lucHV0LCAuLi5hcmd2KTogSUNvcmVIYW5kbGVyUmV0dXJuXG5leHBvcnQgZnVuY3Rpb24gY29yZUhhbmRsZXIoc3RyLCBmbGFncyA9IG51bGwsIG9wdGlvbnM6IElPcHRpb25zSW5wdXQgfCBzdHJpbmcgPSB7fSwgLi4uYXJndik6IElDb3JlSGFuZGxlclJldHVyblxue1xuXHRpZiAoZmxhZ3MgIT09IG51bGwgJiYgdHlwZW9mIGZsYWdzID09ICdvYmplY3QnKVxuXHR7XG5cdFx0b3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIGZsYWdzKSBhcyBJT3B0aW9ucztcblx0XHRmbGFncyA9IG9wdGlvbnMuZmxhZ3MgfHwgbnVsbDtcblx0fVxuXG5cdGlmICh0eXBlb2Ygb3B0aW9ucyA9PSAnc3RyaW5nJylcblx0e1xuXHRcdG9wdGlvbnMgPSB7XG5cdFx0XHRza2lwOiBvcHRpb25zLFxuXHRcdH0gYXMgSU9wdGlvbnM7XG5cdH1cblxuXHRpZiAodHlwZW9mIG9wdGlvbnMuZmxhZ3MgPT0gJ3N0cmluZycpXG5cdHtcblx0XHRmbGFncyA9IG9wdGlvbnMuZmxhZ3M7XG5cdH1cblxuXHRsZXQgaGFzRmxhZ3MgPSB0eXBlb2YgZmxhZ3MgPT0gJ3N0cmluZyc7XG5cblx0b3B0aW9ucyA9IGZpeE9wdGlvbnNPbihvcHRpb25zKTtcblxuXHRpZiAoMSAmJiAoIW9wdGlvbnMuZGlzYWJsZVpoIHx8ICFvcHRpb25zLmRpc2FibGVMb2NhbFJhbmdlIHx8IG9wdGlvbnMub24pKVxuXHR7XG5cdFx0bGV0IGV2OiBQYXJzZXJFdmVudEVtaXR0ZXI7XG5cblx0XHRjb25zdCB6aFRhYmxlRm4gPSBvcHRpb25zLnpoVGFibGUgfHwgKG9wdGlvbnMuZ3JlZWR5VGFibGUgPyB6aFRhYmxlQXV0b0dyZWVkeVRhYmxlIDogemhUYWJsZS5hdXRvKTtcblxuXHRcdGlmIChzdHIgaW5zdGFuY2VvZiBSZWdFeHApXG5cdFx0e1xuXHRcdFx0bGV0IGFzdCA9IHBhcnNlUmVnRXhwKHN0ci50b1N0cmluZygpKTtcblx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdGV2ID0gbmV3IFBhcnNlckV2ZW50RW1pdHRlcihhc3QpO1xuXHRcdH1cblx0XHRlbHNlXG5cdFx0e1xuXHRcdFx0aWYgKG9wdGlvbnMucGFyc2VSZWd1bGFyRXhwcmVzc2lvblN0cmluZyAmJiB0eXBlb2Ygc3RyID09ICdzdHJpbmcnKVxuXHRcdFx0e1xuXHRcdFx0XHRsZXQgbSA9IHBhcnNlUmVndWxhckV4cHJlc3Npb25TdHJpbmcoc3RyKTtcblx0XHRcdFx0aWYgKG0pXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRzdHIgPSBtLnNvdXJjZTtcblx0XHRcdFx0XHRmbGFncyA9IGhhc0ZsYWdzID8gZmxhZ3MgOiBtLmZsYWdzO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGV2ID0gUGFyc2VyRXZlbnRFbWl0dGVyLmNyZWF0ZShzdHIsIGZsYWdzIHx8ICcnKTtcblx0XHR9XG5cblx0XHRpZiAoIW9wdGlvbnMuZGlzYWJsZVpoKVxuXHRcdHtcblx0XHRcdGV2Lm9uKFBhcnNlckV2ZW50RW1pdHRlckV2ZW50LmRlZmF1bHQsIGZ1bmN0aW9uIChhc3QpXG5cdFx0XHR7XG5cdFx0XHRcdGFzdC5vbGRfcmF3ID0gYXN0Lm9sZF9yYXcgfHwgYXN0LnJhdztcblxuXHRcdFx0XHRsZXQgcmF3ID0gX3dvcmRfemhfY29yZShhc3QucmF3LCAob3B0aW9ucyBhcyBJT3B0aW9ucykuc2tpcCwgemhUYWJsZUZuLCBvcHRpb25zIGFzIElPcHRpb25zKTtcblxuXHRcdFx0XHRpZiAoYXN0LnJhdyAhPT0gcmF3KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0YXN0LnJhdyA9IHJhdztcblx0XHRcdFx0XHRldi5lbWl0KFBhcnNlckV2ZW50RW1pdHRlckV2ZW50LmNoYW5nZSwgYXN0KTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0aWYgKCFvcHRpb25zLmRpc2FibGVMb2NhbFJhbmdlKVxuXHRcdHtcblx0XHRcdGV2Lm9uKFBhcnNlckV2ZW50RW1pdHRlckV2ZW50LmNsYXNzX3JhbmdlLCBmdW5jdGlvbiAoYXN0LCAuLi5hcmd2KVxuXHRcdFx0e1xuXHRcdFx0XHRsZXQgcyA9IGFzdC5taW4ucmF3O1xuXHRcdFx0XHRsZXQgZSA9IGFzdC5tYXgucmF3O1xuXG5cdFx0XHRcdGxldCByZXQgPSByZWdleHBSYW5nZShzLCBlLCB7XG5cdFx0XHRcdFx0Y3JlYXRlUmVnRXhwU3RyaW5nOiB0cnVlLFxuXHRcdFx0XHR9KTtcblx0XHRcdFx0aWYgKHJldClcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGlmICgob3B0aW9ucyBhcyBJT3B0aW9ucykuYWxsb3dMb2NhbFJhbmdlQXV0b1poKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJldCA9IF93b3JkX3poX2NvcmUyKHJldCwgKG9wdGlvbnMgYXMgSU9wdGlvbnMpLnNraXAsIHpoVGFibGVGbiwgb3B0aW9ucyBhcyBJT3B0aW9ucyk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0YXN0Lm9sZF9yYXcgPSBhc3Qub2xkX3JhdyB8fCBhc3QucmF3O1xuXG5cdFx0XHRcdFx0aWYgKGFzdC5yYXcgIT09IHJldClcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRhc3QucmF3ID0gcmV0O1xuXG5cdFx0XHRcdFx0XHRldi5lbWl0KFBhcnNlckV2ZW50RW1pdHRlckV2ZW50LmNoYW5nZSwgYXN0KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdHNldHVwUGFyc2VyRXZlbnRFbWl0dGVyKGV2LCBvcHRpb25zKTtcblxuXHRcdGV2LnJlc3VtZSgpO1xuXG5cdFx0c3RyID0gZXYuZ2V0U291cmNlKCEhb3B0aW9ucy5kZWJ1Z0NoYW5nZWRcblx0XHRcdHx8ICFvcHRpb25zLm5vVW5pcXVlQ2xhc3Ncblx0XHRcdHx8IG9wdGlvbnMuc29ydENsYXNzXG5cdFx0XHQsIG9wdGlvbnMpO1xuXHRcdGZsYWdzID0gaGFzRmxhZ3MgPyBmbGFncyA6IGV2LmZsYWdzO1xuXHR9XG5cdGVsc2Vcblx0e1xuXHRcdGlmIChvcHRpb25zLnBhcnNlUmVndWxhckV4cHJlc3Npb25TdHJpbmcgJiYgdHlwZW9mIHN0ciA9PSAnc3RyaW5nJylcblx0XHR7XG5cdFx0XHRsZXQgbSA9IHBhcnNlUmVndWxhckV4cHJlc3Npb25TdHJpbmcoc3RyKTtcblx0XHRcdGlmIChtKVxuXHRcdFx0e1xuXHRcdFx0XHRzdHIgPSBuZXcgUmVnRXhwKG0uc291cmNlLCBtLmZsYWdzKTtcblx0XHRcdFx0ZmxhZ3MgPSBoYXNGbGFncyA/IGZsYWdzIDogc3RyLmZsYWdzO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRlbHNlIGlmIChzdHIgaW5zdGFuY2VvZiBSZWdFeHApXG5cdFx0e1xuXHRcdFx0c3RyID0gc3RyLnNvdXJjZTtcblx0XHRcdGZsYWdzID0gaGFzRmxhZ3MgPyBmbGFncyA6IHN0ci5mbGFncztcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4ge1xuXHRcdHNvdXJjZTogc3RyLFxuXHRcdGZsYWdzOiBmbGFncyB8fCAnJyxcblx0XHRvcHRpb25zOiBvcHRpb25zIGFzIElPcHRpb25zUnVudGltZSxcblx0fVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VSZWd1bGFyRXhwcmVzc2lvblN0cmluZyhzdHI6IHN0cmluZylcbntcblx0bGV0IG0gPSAvXihbXFwvIyQlXSkoLis/KVxcMShbYS16XSopJC8uZXhlYyhzdHIpO1xuXHRpZiAobSlcblx0e1xuXHRcdGxldCBbcywgZCwgciwgZl0gPSBtO1xuXG5cdFx0cmV0dXJuIHtcblx0XHRcdHNvdXJjZTogdHlwZW9mIHIgIT09ICd1bmRlZmluZWQnID8gciA6ICcnLFxuXHRcdFx0ZmxhZ3M6IHR5cGVvZiBmICE9PSAndW5kZWZpbmVkJyA/IGYgOiAnJyxcblx0XHRcdHNsYXNoOiBzLFxuXHRcdFx0aW5wdXQ6IHN0cixcblx0XHR9O1xuXHR9XG5cblx0cmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaXhPcHRpb25zT248VCBleHRlbmRzIElOb2RlSW5wdXQgPSBJTm9kZUlucHV0PihvcHRpb25zPzogSU9wdGlvbnNJbnB1dDxUPik6IElPcHRpb25zUnVudGltZTxUPlxue1xuXHRpZiAob3B0aW9ucy5vbiAmJiAhQXJyYXkuaXNBcnJheShvcHRpb25zLm9uKSlcblx0e1xuXHRcdG9wdGlvbnMub24gPSBbb3B0aW9ucy5vbl07XG5cdH1cblxuXHQvLyBAdHMtaWdub3JlXG5cdHJldHVybiBvcHRpb25zXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXR1cFBhcnNlckV2ZW50RW1pdHRlcihldjogUGFyc2VyRXZlbnRFbWl0dGVyLCBvcHRpb25zOiBJT3B0aW9uc0lucHV0KVxue1xuXHRpZiAob3B0aW9ucy5vbilcblx0e1xuXHRcdGZpeE9wdGlvbnNPbihvcHRpb25zKS5vblxuXHRcdFx0LmZvckVhY2goKGNvbmYpID0+XG5cdFx0XHR7XG5cdFx0XHRcdE9iamVjdFxuXHRcdFx0XHRcdC5rZXlzKGNvbmYpXG5cdFx0XHRcdFx0LmZvckVhY2goZnVuY3Rpb24gKGV2ZW50OiBQYXJzZXJFdmVudEVtaXR0ZXJFdmVudClcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRldi5vbihldmVudCwgKG9wdGlvbnMgYXMgSU9wdGlvbnMpLm9uW2V2ZW50XSlcblx0XHRcdFx0XHR9KVxuXHRcdFx0XHQ7XG5cblx0XHRcdH0pXG5cdFx0O1xuXHR9XG5cblx0cmV0dXJuIGV2O1xufVxuXG5leHBvcnQgZGVmYXVsdCBjb3JlSGFuZGxlclxuIl19