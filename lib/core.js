"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const conv_1 = require("./conv");
const regexp_parser_literal_1 = require("regexp-parser-literal");
const regexp_parser_event_1 = require("regexp-parser-event");
exports.ParserEventEmitter = regexp_parser_event_1.ParserEventEmitter;
const regexp_range_1 = require("regexp-range");
const zhTable = require("cjk-conv/lib/zh/table/index");
function coreHandler(str, flags = null, options = {}, ...argv) {
    if (flags !== null && typeof flags == 'object') {
        options = Object.assign({}, flags);
        flags = options.flags || null;
    }
    if (typeof options == 'string') {
        options = {
            skip: options,
        };
    }
    if (typeof options.flags == 'string') {
        flags = options.flags;
    }
    let hasFlags = typeof flags == 'string';
    options = fixOptionsOn(options);
    if (1 && (!options.disableZh || !options.disableLocalRange || options.on)) {
        let ev;
        const zhTableFn = options.zhTable || (options.greedyTable ? conv_1.zhTableAutoGreedyTable : zhTable.auto);
        if (str instanceof RegExp) {
            let ast = regexp_parser_literal_1.parseRegExp(str.toString());
            // @ts-ignore
            ev = new regexp_parser_event_1.ParserEventEmitter(ast);
        }
        else {
            if (options.parseRegularExpressionString && typeof str == 'string') {
                let m = parseRegularExpressionString(str);
                if (m) {
                    str = m.source;
                    flags = hasFlags ? flags : m.flags;
                }
            }
            ev = regexp_parser_event_1.ParserEventEmitter.create(str, flags || '');
        }
        if (!options.disableZh) {
            ev.on("default" /* default */, function (ast) {
                ast.old_raw = ast.old_raw || ast.raw;
                let raw = conv_1._word_zh_core(ast.raw, options.skip, zhTableFn, options);
                if (ast.raw !== raw) {
                    ast.raw = raw;
                    ev.emit("change" /* change */, ast);
                }
            });
        }
        if (!options.disableLocalRange) {
            ev.on("class_range" /* class_range */, function (ast, ...argv) {
                let s = ast.min.raw;
                let e = ast.max.raw;
                let ret = regexp_range_1.default(s, e, {
                    createRegExpString: true,
                });
                if (ret) {
                    if (options.allowLocalRangeAutoZh) {
                        ret = conv_1._word_zh_core2(ret, options.skip, zhTableFn, options);
                    }
                    ast.old_raw = ast.old_raw || ast.raw;
                    if (ast.raw !== ret) {
                        ast.raw = ret;
                        ev.emit("change" /* change */, ast);
                    }
                }
            });
        }
        setupParserEventEmitter(ev, options);
        ev.resume();
        str = ev.getSource(!!options.debugChanged
            || !options.noUniqueClass
            || options.sortClass, options);
        flags = hasFlags ? flags : ev.flags;
    }
    else {
        if (options.parseRegularExpressionString && typeof str == 'string') {
            let m = parseRegularExpressionString(str);
            if (m) {
                str = new RegExp(m.source, m.flags);
                flags = hasFlags ? flags : str.flags;
            }
        }
        else if (str instanceof RegExp) {
            str = str.source;
            flags = hasFlags ? flags : str.flags;
        }
    }
    return {
        source: str,
        flags: flags || '',
        options: options,
    };
}
exports.coreHandler = coreHandler;
function parseRegularExpressionString(str) {
    let m = /^([\/#$%])(.+?)\1([a-z]*)$/.exec(str);
    if (m) {
        let [s, d, r, f] = m;
        return {
            source: typeof r !== 'undefined' ? r : '',
            flags: typeof f !== 'undefined' ? f : '',
            slash: s,
            input: str,
        };
    }
    return null;
}
exports.parseRegularExpressionString = parseRegularExpressionString;
function fixOptionsOn(options) {
    if (options.on && !Array.isArray(options.on)) {
        options.on = [options.on];
    }
    // @ts-ignore
    return options;
}
exports.fixOptionsOn = fixOptionsOn;
function setupParserEventEmitter(ev, options) {
    if (options.on) {
        fixOptionsOn(options).on
            .forEach((conf) => {
            Object
                .keys(conf)
                .forEach(function (event) {
                ev.on(event, conf[event]);
            });
        });
    }
    return ev;
}
exports.setupParserEventEmitter = setupParserEventEmitter;
exports.default = coreHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpQ0FBK0U7QUFDL0UsaUVBQXlFO0FBQ3pFLDZEQUs2QjtBQU1LLDZCQVRqQyx3Q0FBa0IsQ0FTaUM7QUFMcEQsK0NBQXVDO0FBQ3ZDLHVEQUF3RDtBQStEeEQsU0FBZ0IsV0FBVyxDQUFDLEdBQUcsRUFBRSxLQUFLLEdBQUcsSUFBSSxFQUFFLFVBQWtDLEVBQUUsRUFBRSxHQUFHLElBQUk7SUFFM0YsSUFBSSxLQUFLLEtBQUssSUFBSSxJQUFJLE9BQU8sS0FBSyxJQUFJLFFBQVEsRUFDOUM7UUFDQyxPQUFPLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFhLENBQUM7UUFDL0MsS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDO0tBQzlCO0lBRUQsSUFBSSxPQUFPLE9BQU8sSUFBSSxRQUFRLEVBQzlCO1FBQ0MsT0FBTyxHQUFHO1lBQ1QsSUFBSSxFQUFFLE9BQU87U0FDRCxDQUFDO0tBQ2Q7SUFFRCxJQUFJLE9BQU8sT0FBTyxDQUFDLEtBQUssSUFBSSxRQUFRLEVBQ3BDO1FBQ0MsS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUM7S0FDdEI7SUFFRCxJQUFJLFFBQVEsR0FBRyxPQUFPLEtBQUssSUFBSSxRQUFRLENBQUM7SUFFeEMsT0FBTyxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUVoQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsSUFBSSxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQ3pFO1FBQ0MsSUFBSSxFQUFzQixDQUFDO1FBRTNCLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyw2QkFBc0IsQ0FB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QUFLLEVBQUUsT0FBTyxDQUFDLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDeEMsS0FBSyxFQUFFLENBQUM7WUFDUixLQUFLLEVBQUUsR0FBRztTQUNWLENBQUM7S0FDRjtJQUVELE9BQU8sSUFBSSxDQUFDO0FBQ2IsQ0FBQztBQWhCRCxvRUFnQkM7QUFFRCxTQUFnQixZQUFZLENBQW9DLE9BQTBCO0lBRXpGLElBQUksT0FBTyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUM1QztRQUNDLE9BQU8sQ0FBQyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDMUI7SUFFRCxhQUFhO0lBQ2IsT0FBTyxPQUFPLENBQUE7QUFDZixDQUFDO0FBVEQsb0NBU0M7QUFFRCxTQUFnQix1QkFBdUIsQ0FBQyxFQUFzQixFQUFFLE9BQXNCO0lBRXJGLElBQUksT0FBTyxDQUFDLEVBQUUsRUFDZDtRQUNDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFO2FBQ3RCLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBRWpCLE1BQU07aUJBQ0osSUFBSSxDQUFDLElBQUksQ0FBQztpQkFDVixPQUFPLENBQUMsVUFBVSxLQUE4QjtnQkFFaEQsRUFBRSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7WUFDMUIsQ0FBQyxDQUFDLENBQ0Y7UUFFRixDQUFDLENBQUMsQ0FDRjtLQUNEO0lBRUQsT0FBTyxFQUFFLENBQUM7QUFDWCxDQUFDO0FBcEJELDBEQW9CQztBQUVELGtCQUFlLFdBQVcsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IF93b3JkX3poX2NvcmUsIF93b3JkX3poX2NvcmUyLCB6aFRhYmxlQXV0b0dyZWVkeVRhYmxlIH0gZnJvbSAnLi9jb252JztcbmltcG9ydCB7IElBc3RUb1N0cmluZ09wdGlvbnMsIHBhcnNlUmVnRXhwIH0gZnJvbSAncmVnZXhwLXBhcnNlci1saXRlcmFsJztcbmltcG9ydCB7XG5cdElQYXJzZXJFdmVudEVtaXR0ZXJMaXN0ZW5lcixcblx0UGFyc2VyRXZlbnRFbWl0dGVyLFxuXHRQYXJzZXJFdmVudEVtaXR0ZXJFdmVudCxcblx0SU5vZGVJbnB1dCxcbn0gZnJvbSAncmVnZXhwLXBhcnNlci1ldmVudCc7XG5pbXBvcnQgcmVnZXhwUmFuZ2UgZnJvbSAncmVnZXhwLXJhbmdlJztcbmltcG9ydCB6aFRhYmxlID0gcmVxdWlyZSgnY2prLWNvbnYvbGliL3poL3RhYmxlL2luZGV4Jyk7XG5pbXBvcnQgeyBpc1JlZ0V4cCB9IGZyb20gJ3JlZ2V4cC1oZWxwZXInO1xuaW1wb3J0IHsgSU9wdGlvbnMgYXMgSU9wdGlvbnNaaFRhYmxlIH0gZnJvbSAnY2prLWNvbnYvbGliL3poL3RhYmxlL2luZGV4JztcblxuZXhwb3J0IHsgUGFyc2VyRXZlbnRFbWl0dGVyRXZlbnQsIFBhcnNlckV2ZW50RW1pdHRlciwgSU5vZGVJbnB1dCwgSVBhcnNlckV2ZW50RW1pdHRlckxpc3RlbmVyLCBJQXN0VG9TdHJpbmdPcHRpb25zIH1cblxuZXhwb3J0IHsgSU9wdGlvbnNaaFRhYmxlIH1cblxuZXhwb3J0IHR5cGUgSU9wdGlvbnNDb3JlID0ge1xuXHRza2lwPzogc3RyaW5nLFxuXHRkaXNhYmxlWmg/OiBib29sZWFuLFxuXHQvKipcblx0ICogZGlzYWJsZUxvY2FsUmFuZ2Ugb25seSB3b3JrIHdoZW4gZGlzYWJsZVpoIGlzIHRydWVcblx0ICovXG5cdGRpc2FibGVMb2NhbFJhbmdlPzogYm9vbGVhbixcblx0YWxsb3dMb2NhbFJhbmdlQXV0b1poPzogYm9vbGVhbixcblx0ZmxhZ3M/OiBzdHJpbmcsXG5cblx0LyoqXG5cdCAqIGFsbG93IHN0ciBpcyAvYS9nXG5cdCAqL1xuXHRwYXJzZVJlZ3VsYXJFeHByZXNzaW9uU3RyaW5nPzogYm9vbGVhbixcblxuXHQvKipcblx0ICog6K6TIOaWh+Wtl+avlOWwjSDmm7TliqDlr6zprIZcblx0ICovXG5cdGdyZWVkeVRhYmxlPzogYm9vbGVhbiB8IG51bWJlcixcblx0dW5zYWZlPzogYm9vbGVhbixcblxuXHQvKipcblx0ICogYWxsb3cgc2V0IGBDamtDb252LnpoVGFibGUuYXV0b2Bcblx0ICovXG5cdHpoVGFibGU/KGNoYXI6IHN0cmluZywgb3B0aW9ucz86IElPcHRpb25zWmhUYWJsZSk6IHN0cmluZ1tdXG5cbn0gJiBJQXN0VG9TdHJpbmdPcHRpb25zO1xuXG5leHBvcnQgdHlwZSBJT3B0aW9uczxUIGV4dGVuZHMgSU5vZGVJbnB1dCA9IElOb2RlSW5wdXQ+ID0gSU9wdGlvbnNDb3JlICYge1xuXHRvbj86IElPcHRpb25zT248VD4gfCBJT3B0aW9uc09uPFQ+W10sXG59XG5cbmV4cG9ydCB0eXBlIElPcHRpb25zUnVudGltZTxUIGV4dGVuZHMgSU5vZGVJbnB1dCA9IElOb2RlSW5wdXQ+ID0gSU9wdGlvbnNDb3JlICYge1xuXHRvbj86IElPcHRpb25zT248VD5bXSxcbn1cblxuZXhwb3J0IHR5cGUgSU9wdGlvbnNJbnB1dDxUIGV4dGVuZHMgSU5vZGVJbnB1dCA9IElOb2RlSW5wdXQ+ID0gSU9wdGlvbnM8VD4gfCBJT3B0aW9uc1J1bnRpbWU8VD5cblxuZXhwb3J0IGludGVyZmFjZSBJQ29yZUhhbmRsZXJSZXR1cm48VCBleHRlbmRzIElOb2RlSW5wdXQgPSBJTm9kZUlucHV0Plxue1xuXHRzb3VyY2U6IHN0cmluZyxcblx0ZmxhZ3M6IHN0cmluZyxcblx0b3B0aW9uczogSU9wdGlvbnNSdW50aW1lPFQ+LFxufVxuXG5leHBvcnQgdHlwZSBJT3B0aW9uc09uPFQgZXh0ZW5kcyBJTm9kZUlucHV0ID0gSU5vZGVJbnB1dD4gPSB7XG5cdFtrIGluIFBhcnNlckV2ZW50RW1pdHRlckV2ZW50XT86IElQYXJzZXJFdmVudEVtaXR0ZXJMaXN0ZW5lcjxULCBQYXJzZXJFdmVudEVtaXR0ZXJFdmVudD47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb3JlSGFuZGxlcihzdHI6IHN0cmluZyB8IFJlZ0V4cCxcblx0ZmxhZ3M/OiBzdHJpbmcsXG5cdG9wdGlvbnM/OiBJT3B0aW9uc0lucHV0IHwgc3RyaW5nLFxuXHQuLi5hcmd2XG4pOiBJQ29yZUhhbmRsZXJSZXR1cm5cbmV4cG9ydCBmdW5jdGlvbiBjb3JlSGFuZGxlcihzdHI6IHN0cmluZyB8IFJlZ0V4cCwgb3B0aW9ucz86IElPcHRpb25zSW5wdXQsIC4uLmFyZ3YpOiBJQ29yZUhhbmRsZXJSZXR1cm5cbmV4cG9ydCBmdW5jdGlvbiBjb3JlSGFuZGxlcihzdHIsIGZsYWdzID0gbnVsbCwgb3B0aW9uczogSU9wdGlvbnNJbnB1dCB8IHN0cmluZyA9IHt9LCAuLi5hcmd2KTogSUNvcmVIYW5kbGVyUmV0dXJuXG57XG5cdGlmIChmbGFncyAhPT0gbnVsbCAmJiB0eXBlb2YgZmxhZ3MgPT0gJ29iamVjdCcpXG5cdHtcblx0XHRvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgZmxhZ3MpIGFzIElPcHRpb25zO1xuXHRcdGZsYWdzID0gb3B0aW9ucy5mbGFncyB8fCBudWxsO1xuXHR9XG5cblx0aWYgKHR5cGVvZiBvcHRpb25zID09ICdzdHJpbmcnKVxuXHR7XG5cdFx0b3B0aW9ucyA9IHtcblx0XHRcdHNraXA6IG9wdGlvbnMsXG5cdFx0fSBhcyBJT3B0aW9ucztcblx0fVxuXG5cdGlmICh0eXBlb2Ygb3B0aW9ucy5mbGFncyA9PSAnc3RyaW5nJylcblx0e1xuXHRcdGZsYWdzID0gb3B0aW9ucy5mbGFncztcblx0fVxuXG5cdGxldCBoYXNGbGFncyA9IHR5cGVvZiBmbGFncyA9PSAnc3RyaW5nJztcblxuXHRvcHRpb25zID0gZml4T3B0aW9uc09uKG9wdGlvbnMpO1xuXG5cdGlmICgxICYmICghb3B0aW9ucy5kaXNhYmxlWmggfHwgIW9wdGlvbnMuZGlzYWJsZUxvY2FsUmFuZ2UgfHwgb3B0aW9ucy5vbikpXG5cdHtcblx0XHRsZXQgZXY6IFBhcnNlckV2ZW50RW1pdHRlcjtcblxuXHRcdGNvbnN0IHpoVGFibGVGbiA9IG9wdGlvbnMuemhUYWJsZSB8fCAob3B0aW9ucy5ncmVlZHlUYWJsZSA/IHpoVGFibGVBdXRvR3JlZWR5VGFibGUgOiB6aFRhYmxlLmF1dG8pO1xuXG5cdFx0aWYgKHN0ciBpbnN0YW5jZW9mIFJlZ0V4cClcblx0XHR7XG5cdFx0XHRsZXQgYXN0ID0gcGFyc2VSZWdFeHAoc3RyLnRvU3RyaW5nKCkpO1xuXHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0ZXYgPSBuZXcgUGFyc2VyRXZlbnRFbWl0dGVyKGFzdCk7XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRpZiAob3B0aW9ucy5wYXJzZVJlZ3VsYXJFeHByZXNzaW9uU3RyaW5nICYmIHR5cGVvZiBzdHIgPT0gJ3N0cmluZycpXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBtID0gcGFyc2VSZWd1bGFyRXhwcmVzc2lvblN0cmluZyhzdHIpO1xuXHRcdFx0XHRpZiAobSlcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHN0ciA9IG0uc291cmNlO1xuXHRcdFx0XHRcdGZsYWdzID0gaGFzRmxhZ3MgPyBmbGFncyA6IG0uZmxhZ3M7XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0ZXYgPSBQYXJzZXJFdmVudEVtaXR0ZXIuY3JlYXRlKHN0ciwgZmxhZ3MgfHwgJycpO1xuXHRcdH1cblxuXHRcdGlmICghb3B0aW9ucy5kaXNhYmxlWmgpXG5cdFx0e1xuXHRcdFx0ZXYub24oUGFyc2VyRXZlbnRFbWl0dGVyRXZlbnQuZGVmYXVsdCwgZnVuY3Rpb24gKGFzdClcblx0XHRcdHtcblx0XHRcdFx0YXN0Lm9sZF9yYXcgPSBhc3Qub2xkX3JhdyB8fCBhc3QucmF3O1xuXG5cdFx0XHRcdGxldCByYXcgPSBfd29yZF96aF9jb3JlKGFzdC5yYXcsIChvcHRpb25zIGFzIElPcHRpb25zKS5za2lwLCB6aFRhYmxlRm4sIG9wdGlvbnMgYXMgSU9wdGlvbnMpO1xuXG5cdFx0XHRcdGlmIChhc3QucmF3ICE9PSByYXcpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRhc3QucmF3ID0gcmF3O1xuXHRcdFx0XHRcdGV2LmVtaXQoUGFyc2VyRXZlbnRFbWl0dGVyRXZlbnQuY2hhbmdlLCBhc3QpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHR9XG5cblx0XHRpZiAoIW9wdGlvbnMuZGlzYWJsZUxvY2FsUmFuZ2UpXG5cdFx0e1xuXHRcdFx0ZXYub24oUGFyc2VyRXZlbnRFbWl0dGVyRXZlbnQuY2xhc3NfcmFuZ2UsIGZ1bmN0aW9uIChhc3QsIC4uLmFyZ3YpXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBzID0gYXN0Lm1pbi5yYXc7XG5cdFx0XHRcdGxldCBlID0gYXN0Lm1heC5yYXc7XG5cblx0XHRcdFx0bGV0IHJldCA9IHJlZ2V4cFJhbmdlKHMsIGUsIHtcblx0XHRcdFx0XHRjcmVhdGVSZWdFeHBTdHJpbmc6IHRydWUsXG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRpZiAocmV0KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0aWYgKChvcHRpb25zIGFzIElPcHRpb25zKS5hbGxvd0xvY2FsUmFuZ2VBdXRvWmgpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmV0ID0gX3dvcmRfemhfY29yZTIocmV0LCAob3B0aW9ucyBhcyBJT3B0aW9ucykuc2tpcCwgemhUYWJsZUZuLCBvcHRpb25zIGFzIElPcHRpb25zKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRhc3Qub2xkX3JhdyA9IGFzdC5vbGRfcmF3IHx8IGFzdC5yYXc7XG5cblx0XHRcdFx0XHRpZiAoYXN0LnJhdyAhPT0gcmV0KVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGFzdC5yYXcgPSByZXQ7XG5cblx0XHRcdFx0XHRcdGV2LmVtaXQoUGFyc2VyRXZlbnRFbWl0dGVyRXZlbnQuY2hhbmdlLCBhc3QpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0c2V0dXBQYXJzZXJFdmVudEVtaXR0ZXIoZXYsIG9wdGlvbnMpO1xuXG5cdFx0ZXYucmVzdW1lKCk7XG5cblx0XHRzdHIgPSBldi5nZXRTb3VyY2UoISFvcHRpb25zLmRlYnVnQ2hhbmdlZFxuXHRcdFx0fHwgIW9wdGlvbnMubm9VbmlxdWVDbGFzc1xuXHRcdFx0fHwgb3B0aW9ucy5zb3J0Q2xhc3Ncblx0XHRcdCwgb3B0aW9ucyk7XG5cdFx0ZmxhZ3MgPSBoYXNGbGFncyA/IGZsYWdzIDogZXYuZmxhZ3M7XG5cdH1cblx0ZWxzZVxuXHR7XG5cdFx0aWYgKG9wdGlvbnMucGFyc2VSZWd1bGFyRXhwcmVzc2lvblN0cmluZyAmJiB0eXBlb2Ygc3RyID09ICdzdHJpbmcnKVxuXHRcdHtcblx0XHRcdGxldCBtID0gcGFyc2VSZWd1bGFyRXhwcmVzc2lvblN0cmluZyhzdHIpO1xuXHRcdFx0aWYgKG0pXG5cdFx0XHR7XG5cdFx0XHRcdHN0ciA9IG5ldyBSZWdFeHAobS5zb3VyY2UsIG0uZmxhZ3MpO1xuXHRcdFx0XHRmbGFncyA9IGhhc0ZsYWdzID8gZmxhZ3MgOiBzdHIuZmxhZ3M7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdGVsc2UgaWYgKHN0ciBpbnN0YW5jZW9mIFJlZ0V4cClcblx0XHR7XG5cdFx0XHRzdHIgPSBzdHIuc291cmNlO1xuXHRcdFx0ZmxhZ3MgPSBoYXNGbGFncyA/IGZsYWdzIDogc3RyLmZsYWdzO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiB7XG5cdFx0c291cmNlOiBzdHIsXG5cdFx0ZmxhZ3M6IGZsYWdzIHx8ICcnLFxuXHRcdG9wdGlvbnM6IG9wdGlvbnMgYXMgSU9wdGlvbnNSdW50aW1lLFxuXHR9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVJlZ3VsYXJFeHByZXNzaW9uU3RyaW5nKHN0cjogc3RyaW5nKVxue1xuXHRsZXQgbSA9IC9eKFtcXC8jJCVdKSguKz8pXFwxKFthLXpdKikkLy5leGVjKHN0cik7XG5cdGlmIChtKVxuXHR7XG5cdFx0bGV0IFtzLCBkLCByLCBmXSA9IG07XG5cblx0XHRyZXR1cm4ge1xuXHRcdFx0c291cmNlOiB0eXBlb2YgciAhPT0gJ3VuZGVmaW5lZCcgPyByIDogJycsXG5cdFx0XHRmbGFnczogdHlwZW9mIGYgIT09ICd1bmRlZmluZWQnID8gZiA6ICcnLFxuXHRcdFx0c2xhc2g6IHMsXG5cdFx0XHRpbnB1dDogc3RyLFxuXHRcdH07XG5cdH1cblxuXHRyZXR1cm4gbnVsbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpeE9wdGlvbnNPbjxUIGV4dGVuZHMgSU5vZGVJbnB1dCA9IElOb2RlSW5wdXQ+KG9wdGlvbnM/OiBJT3B0aW9uc0lucHV0PFQ+KTogSU9wdGlvbnNSdW50aW1lPFQ+XG57XG5cdGlmIChvcHRpb25zLm9uICYmICFBcnJheS5pc0FycmF5KG9wdGlvbnMub24pKVxuXHR7XG5cdFx0b3B0aW9ucy5vbiA9IFtvcHRpb25zLm9uXTtcblx0fVxuXG5cdC8vIEB0cy1pZ25vcmVcblx0cmV0dXJuIG9wdGlvbnNcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldHVwUGFyc2VyRXZlbnRFbWl0dGVyKGV2OiBQYXJzZXJFdmVudEVtaXR0ZXIsIG9wdGlvbnM6IElPcHRpb25zSW5wdXQpXG57XG5cdGlmIChvcHRpb25zLm9uKVxuXHR7XG5cdFx0Zml4T3B0aW9uc09uKG9wdGlvbnMpLm9uXG5cdFx0XHQuZm9yRWFjaCgoY29uZikgPT5cblx0XHRcdHtcblx0XHRcdFx0T2JqZWN0XG5cdFx0XHRcdFx0LmtleXMoY29uZilcblx0XHRcdFx0XHQuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQ6IFBhcnNlckV2ZW50RW1pdHRlckV2ZW50KVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGV2Lm9uKGV2ZW50LCBjb25mW2V2ZW50XSlcblx0XHRcdFx0XHR9KVxuXHRcdFx0XHQ7XG5cblx0XHRcdH0pXG5cdFx0O1xuXHR9XG5cblx0cmV0dXJuIGV2O1xufVxuXG5leHBvcnQgZGVmYXVsdCBjb3JlSGFuZGxlclxuIl19