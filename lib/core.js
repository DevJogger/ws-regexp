"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const conv_1 = require("./conv");
const regexp_parser_event_1 = require("regexp-parser-event");
exports.ParserEventEmitter = regexp_parser_event_1.ParserEventEmitter;
const regexp_range_1 = __importDefault(require("regexp-range"));
const mergeOptions_1 = require("./mergeOptions");
const getSource_1 = __importDefault(require("./getSource"));
const index_1 = require("cjk-conv/lib/zh/table/index");
exports.SymDefaults = Symbol.for('zhRegExp.defaults');
function coreHandler(str, flags = null, options = {}, ...argv) {
    const opts = mergeOptions_1.getSettingOptions(str, flags, options, ...argv);
    let source;
    let hasFlags;
    ({ options, argv } = opts);
    options = mergeOptions_1.fixOptions(options);
    ({ source, hasFlags, flags } = getSource_1.default(opts));
    str = source;
    if (options.onCore) {
        let optsNew = options.onCore.reduce((a, setting) => {
            return setting.beforeStart(a);
        }, {
            str,
            flags,
            options,
            argv,
            hasFlags,
        });
        ({ str, options, flags, argv, hasFlags } = optsNew);
    }
    if ((!options.disableZh || !options.disableLocalRange || options.on)) {
        let ev = regexp_parser_event_1.ParserEventEmitter.create(str, flags || '');
        const zhTableFn = options.zhTable || (options.greedyTable ? conv_1.zhTableAutoGreedyTable : index_1.auto);
        if (!options.disableZh) {
            ev.on("default" /* default */, function (ast) {
                ast.old_raw = ast.old_raw || ast.raw;
                let raw = conv_1._word_zh_core(ast.raw, options.skip, zhTableFn, options);
                if (ast.raw !== raw) {
                    ast.raw = raw;
                    ev.emit("change" /* change */, ast);
                }
            });
        }
        if (!options.disableLocalRange) {
            ev.on("class_range" /* class_range */, function (ast, ...argv) {
                let s = ast.min.raw;
                let e = ast.max.raw;
                let ret = regexp_range_1.default(s, e, {
                    createRegExpString: true,
                });
                if (ret) {
                    if (options.allowLocalRangeAutoZh) {
                        ret = conv_1._word_zh_core2(ret, options.skip, zhTableFn, options);
                    }
                    ast.old_raw = ast.old_raw || ast.raw;
                    if (ast.raw !== ret) {
                        ast.raw = ret;
                        ev.emit("change" /* change */, ast);
                    }
                }
            });
        }
        setupParserEventEmitter(ev, options);
        ev.resume();
        str = ev.getSource(!!options.debugChanged
            || !options.noUniqueClass
            || options.sortClass, options);
        flags = hasFlags ? flags : ev.flags;
    }
    return {
        source: str,
        flags: flags || '',
        options: options,
    };
}
exports.coreHandler = coreHandler;
function setupParserEventEmitter(ev, options) {
    const onList = mergeOptions_1.fixOptions(options).on;
    if (onList) {
        onList
            .forEach((conf) => {
            Object
                .keys(conf)
                .forEach(function (event) {
                ev.on(event, conf[event]);
            });
        });
    }
    return ev;
}
exports.setupParserEventEmitter = setupParserEventEmitter;
exports.default = coreHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxpQ0FBK0U7QUFFL0UsNkRBTTZCO0FBUUssNkJBVmpDLHdDQUFrQixDQVVpQztBQVBwRCxnRUFBdUM7QUFFdkMsaURBQW1GO0FBQ25GLDREQUFpRDtBQUVqRCx1REFBa0U7QUFNckQsUUFBQSxXQUFXLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBcUYzRCxTQUFnQixXQUFXLENBQUMsR0FBRyxFQUFFLEtBQUssR0FBRyxJQUFJLEVBQUUsVUFBa0MsRUFBRSxFQUFFLEdBQUcsSUFBSTtJQUUzRixNQUFNLElBQUksR0FBRyxnQ0FBaUIsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO0lBRTdELElBQUksTUFBYyxDQUFDO0lBQ25CLElBQUksUUFBaUIsQ0FBQztJQUV0QixDQUFDLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO0lBRTNCLE9BQU8sR0FBRyx5QkFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRTlCLENBQUMsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxHQUFHLG1CQUFzQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFFN0QsR0FBRyxHQUFHLE1BQU0sQ0FBQztJQUViLElBQUksT0FBTyxDQUFDLE1BQU0sRUFDbEI7UUFDQyxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsRUFBRTtZQUNsRCxPQUFPLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0IsQ0FBQyxFQUFFO1lBQ0YsR0FBRztZQUNILEtBQUs7WUFDTCxPQUFPO1lBQ1AsSUFBSTtZQUNKLFFBQVE7U0FDUixDQUFD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S0FDbkMsQ0FBQTtBQUNGLENBQUM7QUFqR0Qsa0NBaUdDO0FBRUQsU0FBZ0IsdUJBQXVCLENBQUMsRUFBc0IsRUFBRSxPQUFzQjtJQUVyRixNQUFNLE1BQU0sR0FBRyx5QkFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUV0QyxJQUFJLE1BQU0sRUFDVjtRQUNDLE1BQU07YUFDSixPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUVqQixNQUFNO2lCQUNKLElBQUksQ0FBQyxJQUFJLENBQUM7aUJBQ1YsT0FBTyxDQUFDLFVBQVUsS0FBOEI7Z0JBRWhELEVBQUUsQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO1lBQzFCLENBQUMsQ0FBQyxDQUNGO1FBQ0YsQ0FBQyxDQUFDLENBQ0Y7S0FDRDtJQUVELE9BQU8sRUFBRSxDQUFDO0FBQ1gsQ0FBQztBQXJCRCwwREFxQkM7QUFFRCxrQkFBZSxXQUFXLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBfd29yZF96aF9jb3JlLCBfd29yZF96aF9jb3JlMiwgemhUYWJsZUF1dG9HcmVlZHlUYWJsZSB9IGZyb20gJy4vY29udic7XG5pbXBvcnQgeyBJQXN0VG9TdHJpbmdPcHRpb25zIH0gZnJvbSAncmVnZXhwLXBhcnNlci1saXRlcmFsJztcbmltcG9ydCB7XG5cdElOb2RlSW5wdXQsXG5cdElQYXJzZXJFdmVudEVtaXR0ZXJMaXN0ZW5lcixcblx0SVBhcnNlckV2ZW50RW1pdHRlckxpc3RlbmVyTWFwLFxuXHRQYXJzZXJFdmVudEVtaXR0ZXIsXG5cdFBhcnNlckV2ZW50RW1pdHRlckV2ZW50LFxufSBmcm9tICdyZWdleHAtcGFyc2VyLWV2ZW50JztcbmltcG9ydCByZWdleHBSYW5nZSBmcm9tICdyZWdleHAtcmFuZ2UnO1xuaW1wb3J0IHsgSU9wdGlvbnMgYXMgSU9wdGlvbnNaaFRhYmxlIH0gZnJvbSAnY2prLWNvbnYvbGliL3poL3RhYmxlL2luZGV4JztcbmltcG9ydCB7IGZpeE9wdGlvbnMsIGdldFNldHRpbmdPcHRpb25zLCBJR2V0U2V0dGluZ09wdGlvbnMgfSBmcm9tICcuL21lcmdlT3B0aW9ucyc7XG5pbXBvcnQgZ2V0UmVnRXhwU291cmNlUGF0dGVybiBmcm9tICcuL2dldFNvdXJjZSc7XG5pbXBvcnQgKiBhcyB6aFRhYmxlIGZyb20gJ2Nqay1jb252L2xpYi96aC90YWJsZS9pbmRleCc7XG5pbXBvcnQgeyBhdXRvIGFzIHpoVGFibGVBdXRvIH0gZnJvbSAnY2prLWNvbnYvbGliL3poL3RhYmxlL2luZGV4JztcblxuZXhwb3J0IHsgUGFyc2VyRXZlbnRFbWl0dGVyRXZlbnQsIFBhcnNlckV2ZW50RW1pdHRlciwgSU5vZGVJbnB1dCwgSVBhcnNlckV2ZW50RW1pdHRlckxpc3RlbmVyLCBJQXN0VG9TdHJpbmdPcHRpb25zIH1cblxuZXhwb3J0IHsgSU9wdGlvbnNaaFRhYmxlIH1cblxuZXhwb3J0IGNvbnN0IFN5bURlZmF1bHRzID0gU3ltYm9sLmZvcignemhSZWdFeHAuZGVmYXVsdHMnKTtcblxuZXhwb3J0IHR5cGUgSU9wdGlvbnNDb3JlID0ge1xuXHRza2lwPzogc3RyaW5nLFxuXHRkaXNhYmxlWmg/OiBib29sZWFuLFxuXHQvKipcblx0ICogZGlzYWJsZUxvY2FsUmFuZ2Ugb25seSB3b3JrIHdoZW4gZGlzYWJsZVpoIGlzIHRydWVcblx0ICovXG5cdGRpc2FibGVMb2NhbFJhbmdlPzogYm9vbGVhbixcblx0YWxsb3dMb2NhbFJhbmdlQXV0b1poPzogYm9vbGVhbixcblx0ZmxhZ3M/OiBzdHJpbmcsXG5cblx0LyoqXG5cdCAqIGFsbG93IHN0ciBpcyAvYS9nXG5cdCAqIEBkZXByZWNhdGVkXG5cdCAqL1xuXHRwYXJzZVJlZ3VsYXJFeHByZXNzaW9uU3RyaW5nPzogYm9vbGVhbixcblxuXHQvKipcblx0ICog6K6TIOaWh+Wtl+avlOWwjSDmm7TliqDlr6zprIZcblx0ICovXG5cdGdyZWVkeVRhYmxlPzogYm9vbGVhbiB8IG51bWJlcixcblx0dW5zYWZlPzogYm9vbGVhbixcblxuXHQvKipcblx0ICogYWxsb3cgc2V0IGBDamtDb252LnpoVGFibGUuYXV0b2Bcblx0ICovXG5cdHpoVGFibGU/KGNoYXI6IHN0cmluZywgb3B0aW9ucz86IElPcHRpb25zWmhUYWJsZSk6IHN0cmluZ1tdLFxuXG5cdC8qKlxuXHQgKiDnlKjkvobop6Pmsbrmj5Lku7bpnIDmsYJcblx0ICovXG5cdG9uQ29yZT86IElPcHRpb25zT25Db3JlW10sXG5cbn0gJiBJQXN0VG9TdHJpbmdPcHRpb25zO1xuXG5leHBvcnQgaW50ZXJmYWNlIElPcHRpb25zT25Db3JlXG57XG5cdC8qKlxuXHQgKiDln7fooYzmlrzliIbmnpDlj4Pmlbjlvowg5Z+36KGMIOaguOW/g+iZleeQhuWJjVxuXHQgKiDlm57lgrPnmoTnianku7bmnIPlj5bku6Plj4Pmlbhcblx0ICovXG5cdGJlZm9yZVN0YXJ0PyhvcHRzOiBJR2V0U2V0dGluZ09wdGlvbnMgJiB7XG5cdFx0aGFzRmxhZ3M6IGJvb2xlYW4sXG5cdH0pOiBJR2V0U2V0dGluZ09wdGlvbnMgJiB7XG5cdFx0aGFzRmxhZ3M6IGJvb2xlYW4sXG5cdH07XG59XG5cbmV4cG9ydCB0eXBlIElPcHRpb25zPFQgZXh0ZW5kcyBJTm9kZUlucHV0ID0gSU5vZGVJbnB1dD4gPSBJT3B0aW9uc0NvcmUgJiB7XG5cdG9uPzogSU9wdGlvbnNPbjxUPiB8IElPcHRpb25zT248VD5bXSxcbn1cblxuZXhwb3J0IHR5cGUgSU9wdGlvbnNSdW50aW1lPFQgZXh0ZW5kcyBJTm9kZUlucHV0ID0gSU5vZGVJbnB1dD4gPSBJT3B0aW9uc0NvcmUgJiB7XG5cdG9uPzogSU9wdGlvbnNPbjxUPltdLFxufVxuXG5leHBvcnQgdHlwZSBJT3B0aW9uc0lucHV0PFQgZXh0ZW5kcyBJTm9kZUlucHV0ID0gSU5vZGVJbnB1dD4gPSBJT3B0aW9uczxUPiB8IElPcHRpb25zUnVudGltZTxUPlxuXG5leHBvcnQgaW50ZXJmYWNlIElDb3JlSGFuZGxlclJldHVybjxUIGV4dGVuZHMgSU5vZGVJbnB1dCA9IElOb2RlSW5wdXQ+XG57XG5cdHNvdXJjZTogc3RyaW5nLFxuXHRmbGFnczogc3RyaW5nLFxuXHRvcHRpb25zOiBJT3B0aW9uc1J1bnRpbWU8VD4sXG59XG5cbi8qXG5leHBvcnQgdHlwZSBJT3B0aW9uc09uPFQgZXh0ZW5kcyBJTm9kZUlucHV0ID0gSU5vZGVJbnB1dD4gPSB7XG5cdFtrIGluIFBhcnNlckV2ZW50RW1pdHRlckV2ZW50XT86IElQYXJzZXJFdmVudEVtaXR0ZXJMaXN0ZW5lcjxULCBQYXJzZXJFdmVudEVtaXR0ZXJFdmVudD47XG59XG4gKi9cblxuZXhwb3J0IGludGVyZmFjZSBJT3B0aW9uc09uPFQgZXh0ZW5kcyBJTm9kZUlucHV0ID0gSU5vZGVJbnB1dD4gZXh0ZW5kcyBJUGFyc2VyRXZlbnRFbWl0dGVyTGlzdGVuZXJNYXA8VD5cbntcblx0Ly9cbn1cblxuZXhwb3J0IHR5cGUgSVJlZ0V4cFVzZXJJbnB1dCA9IHN0cmluZyB8IFJlZ0V4cDtcblxuZXhwb3J0IGZ1bmN0aW9uIGNvcmVIYW5kbGVyKHN0cjogSVJlZ0V4cFVzZXJJbnB1dCxcblx0ZmxhZ3M/OiBzdHJpbmcsXG5cdG9wdGlvbnM/OiBJT3B0aW9uc0lucHV0IHwgc3RyaW5nLFxuXHQuLi5hcmd2XG4pOiBJQ29yZUhhbmRsZXJSZXR1cm5cbmV4cG9ydCBmdW5jdGlvbiBjb3JlSGFuZGxlcihzdHI6IElSZWdFeHBVc2VySW5wdXQsIG9wdGlvbnM/OiBJT3B0aW9uc0lucHV0LCAuLi5hcmd2KTogSUNvcmVIYW5kbGVyUmV0dXJuXG5leHBvcnQgZnVuY3Rpb24gY29yZUhhbmRsZXIoc3RyLCBmbGFncyA9IG51bGwsIG9wdGlvbnM6IElPcHRpb25zSW5wdXQgfCBzdHJpbmcgPSB7fSwgLi4uYXJndik6IElDb3JlSGFuZGxlclJldHVyblxue1xuXHRjb25zdCBvcHRzID0gZ2V0U2V0dGluZ09wdGlvbnMoc3RyLCBmbGFncywgb3B0aW9ucywgLi4uYXJndik7XG5cblx0bGV0IHNvdXJjZTogc3RyaW5nO1xuXHRsZXQgaGFzRmxhZ3M6IGJvb2xlYW47XG5cblx0KHsgb3B0aW9ucywgYXJndiB9ID0gb3B0cyk7XG5cblx0b3B0aW9ucyA9IGZpeE9wdGlvbnMob3B0aW9ucyk7XG5cblx0KHsgc291cmNlLCBoYXNGbGFncywgZmxhZ3MgfSA9IGdldFJlZ0V4cFNvdXJjZVBhdHRlcm4ob3B0cykpO1xuXG5cdHN0ciA9IHNvdXJjZTtcblxuXHRpZiAob3B0aW9ucy5vbkNvcmUpXG5cdHtcblx0XHRsZXQgb3B0c05ldyA9IG9wdGlvbnMub25Db3JlLnJlZHVjZSgoYSwgc2V0dGluZykgPT4ge1xuXHRcdFx0cmV0dXJuIHNldHRpbmcuYmVmb3JlU3RhcnQoYSk7XG5cdFx0fSwge1xuXHRcdFx0c3RyLFxuXHRcdFx0ZmxhZ3MsXG5cdFx0XHRvcHRpb25zLFxuXHRcdFx0YXJndixcblx0XHRcdGhhc0ZsYWdzLFxuXHRcdH0pO1xuXG5cdFx0KHsgc3RyLCBvcHRpb25zLCBmbGFncywgYXJndiwgaGFzRmxhZ3MgfSA9IG9wdHNOZXcpO1xuXHR9XG5cblx0aWYgKCghb3B0aW9ucy5kaXNhYmxlWmggfHwgIW9wdGlvbnMuZGlzYWJsZUxvY2FsUmFuZ2UgfHwgb3B0aW9ucy5vbikpXG5cdHtcblx0XHRsZXQgZXYgPSBQYXJzZXJFdmVudEVtaXR0ZXIuY3JlYXRlKHN0ciwgZmxhZ3MgfHwgJycpO1xuXG5cdFx0Y29uc3QgemhUYWJsZUZuID0gb3B0aW9ucy56aFRhYmxlIHx8IChvcHRpb25zLmdyZWVkeVRhYmxlID8gemhUYWJsZUF1dG9HcmVlZHlUYWJsZSA6IHpoVGFibGVBdXRvKTtcblxuXHRcdGlmICghb3B0aW9ucy5kaXNhYmxlWmgpXG5cdFx0e1xuXHRcdFx0ZXYub24oUGFyc2VyRXZlbnRFbWl0dGVyRXZlbnQuZGVmYXVsdCwgZnVuY3Rpb24gKGFzdClcblx0XHRcdHtcblx0XHRcdFx0YXN0Lm9sZF9yYXcgPSBhc3Qub2xkX3JhdyB8fCBhc3QucmF3O1xuXG5cdFx0XHRcdGxldCByYXcgPSBfd29yZF96aF9jb3JlKGFzdC5yYXcsIChvcHRpb25zIGFzIElPcHRpb25zKS5za2lwLCB6aFRhYmxlRm4sIG9wdGlvbnMgYXMgSU9wdGlvbnMpO1xuXG5cdFx0XHRcdGlmIChhc3QucmF3ICE9PSByYXcpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRhc3QucmF3ID0gcmF3O1xuXHRcdFx0XHRcdGV2LmVtaXQoUGFyc2VyRXZlbnRFbWl0dGVyRXZlbnQuY2hhbmdlLCBhc3QpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHR9XG5cblx0XHRpZiAoIW9wdGlvbnMuZGlzYWJsZUxvY2FsUmFuZ2UpXG5cdFx0e1xuXHRcdFx0ZXYub24oUGFyc2VyRXZlbnRFbWl0dGVyRXZlbnQuY2xhc3NfcmFuZ2UsIGZ1bmN0aW9uIChhc3QsIC4uLmFyZ3YpXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBzID0gYXN0Lm1pbi5yYXc7XG5cdFx0XHRcdGxldCBlID0gYXN0Lm1heC5yYXc7XG5cblx0XHRcdFx0bGV0IHJldCA9IHJlZ2V4cFJhbmdlKHMsIGUsIHtcblx0XHRcdFx0XHRjcmVhdGVSZWdFeHBTdHJpbmc6IHRydWUsXG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRpZiAocmV0KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0aWYgKChvcHRpb25zIGFzIElPcHRpb25zKS5hbGxvd0xvY2FsUmFuZ2VBdXRvWmgpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmV0ID0gX3dvcmRfemhfY29yZTIocmV0LCAob3B0aW9ucyBhcyBJT3B0aW9ucykuc2tpcCwgemhUYWJsZUZuLCBvcHRpb25zIGFzIElPcHRpb25zKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRhc3Qub2xkX3JhdyA9IGFzdC5vbGRfcmF3IHx8IGFzdC5yYXc7XG5cblx0XHRcdFx0XHRpZiAoYXN0LnJhdyAhPT0gcmV0KVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGFzdC5yYXcgPSByZXQ7XG5cblx0XHRcdFx0XHRcdGV2LmVtaXQoUGFyc2VyRXZlbnRFbWl0dGVyRXZlbnQuY2hhbmdlLCBhc3QpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0c2V0dXBQYXJzZXJFdmVudEVtaXR0ZXIoZXYsIG9wdGlvbnMpO1xuXG5cdFx0ZXYucmVzdW1lKCk7XG5cblx0XHRzdHIgPSBldi5nZXRTb3VyY2UoISFvcHRpb25zLmRlYnVnQ2hhbmdlZFxuXHRcdFx0fHwgIW9wdGlvbnMubm9VbmlxdWVDbGFzc1xuXHRcdFx0fHwgb3B0aW9ucy5zb3J0Q2xhc3Ncblx0XHRcdCwgb3B0aW9ucyk7XG5cdFx0ZmxhZ3MgPSBoYXNGbGFncyA/IGZsYWdzIDogZXYuZmxhZ3M7XG5cdH1cblxuXHRyZXR1cm4ge1xuXHRcdHNvdXJjZTogc3RyLFxuXHRcdGZsYWdzOiBmbGFncyB8fCAnJyxcblx0XHRvcHRpb25zOiBvcHRpb25zIGFzIElPcHRpb25zUnVudGltZSxcblx0fVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0dXBQYXJzZXJFdmVudEVtaXR0ZXIoZXY6IFBhcnNlckV2ZW50RW1pdHRlciwgb3B0aW9uczogSU9wdGlvbnNJbnB1dClcbntcblx0Y29uc3Qgb25MaXN0ID0gZml4T3B0aW9ucyhvcHRpb25zKS5vbjtcblxuXHRpZiAob25MaXN0KVxuXHR7XG5cdFx0b25MaXN0XG5cdFx0XHQuZm9yRWFjaCgoY29uZikgPT5cblx0XHRcdHtcblx0XHRcdFx0T2JqZWN0XG5cdFx0XHRcdFx0LmtleXMoY29uZilcblx0XHRcdFx0XHQuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQ6IFBhcnNlckV2ZW50RW1pdHRlckV2ZW50KVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGV2Lm9uKGV2ZW50LCBjb25mW2V2ZW50XSlcblx0XHRcdFx0XHR9KVxuXHRcdFx0XHQ7XG5cdFx0XHR9KVxuXHRcdDtcblx0fVxuXG5cdHJldHVybiBldjtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY29yZUhhbmRsZXJcblxuIl19