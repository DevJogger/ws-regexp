"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const conv_1 = require("./lib/conv");
const regexp_parser_event_1 = require("regexp-parser-event");
const regexp_parser_literal_1 = require("regexp-parser-literal");
const regexp_support_1 = require("regexp-support");
const regexp_range_1 = require("regexp-range");
const regexp_helper_1 = require("regexp-helper");
const cjk_conv_1 = require("cjk-conv");
const PackageJson = require("./package.json");
exports.defaultOptions = {};
class zhRegExp extends RegExp {
    constructor(str, flags = null, options = {}, ...argv) {
        if (flags !== null && typeof flags == 'object') {
            options = Object.assign({}, flags);
            flags = options.flags || null;
        }
        if (typeof options == 'string') {
            options = {
                skip: options,
            };
        }
        if (typeof options.flags == 'string') {
            flags = options.flags;
        }
        let hasFlags = typeof flags == 'string';
        if (1 && (!options.disableZh || !options.disableLocalRange || options.on)) {
            let ev;
            const zhTable = options.zhTable || cjk_conv_1.default.zhTable.auto;
            if (str instanceof RegExp) {
                let ast = regexp_parser_literal_1.parseRegExp(str.toString());
                ev = new regexp_parser_event_1.default(ast);
            }
            else {
                if (options.parseRegularExpressionString && typeof str == 'string') {
                    let m = zhRegExp.parseRegularExpressionString(str);
                    if (m) {
                        str = m.source;
                        flags = hasFlags ? flags : m.flags;
                    }
                }
                ev = regexp_parser_event_1.default.create(str, flags || '');
            }
            if (!options.disableZh) {
                ev.on(regexp_parser_event_1.ParserEventEmitterEvent.default, function (ast) {
                    ast.old_raw = ast.old_raw || ast.raw;
                    ast.raw = conv_1._word_zh_core(ast.raw, options.skip, zhTable);
                    ev.emit(regexp_parser_event_1.ParserEventEmitterEvent.change, ast);
                });
            }
            if (!options.disableLocalRange) {
                ev.on(regexp_parser_event_1.ParserEventEmitterEvent.class_range, function (ast, ...argv) {
                    let s = ast.min.raw;
                    let e = ast.max.raw;
                    let ret = regexp_range_1.default(s, e, {
                        createRegExpString: true,
                    });
                    if (ret) {
                        if (options.allowLocalRangeAutoZh) {
                            ret = conv_1._word_zh_core2(ret, options.skip, zhTable);
                        }
                        ast.old_raw = ast.old_raw || ast.raw;
                        ast.raw = ret;
                        ev.emit(regexp_parser_event_1.ParserEventEmitterEvent.change, ast);
                    }
                });
            }
            if (options.on) {
                Object
                    .keys(options.on)
                    .forEach(function (event) {
                    ev.on(event, options.on[event]);
                });
            }
            ev.resume();
            str = ev.getSource(!!options.debugChanged
                || !options.noUniqueClass
                || options.sortClass, options);
            flags = hasFlags ? flags : ev.flags;
        }
        else {
            if (options.parseRegularExpressionString && typeof str == 'string') {
                let m = zhRegExp.parseRegularExpressionString(str);
                if (m) {
                    str = new RegExp(m.source, m.flags);
                    flags = hasFlags ? flags : str.flags;
                }
            }
            else if (str instanceof RegExp) {
                str = str.source;
                flags = hasFlags ? flags : str.flags;
            }
        }
        super(str, flags || '');
    }
    static create(str, flags = null, skip, ...argv) {
        return new this(str, flags, skip, ...argv);
    }
    getStatic() {
        return Object.getPrototypeOf(this);
    }
    toRegularExpressionString() {
        return this.toString();
    }
    static parseRegularExpressionString(str) {
        let m = /^([\/#$%])(.+?)\1([a-z]*)$/.exec(str);
        if (m) {
            let [s, d, r, f] = m;
            return {
                source: typeof r !== 'undefined' ? r : '',
                flags: typeof f !== 'undefined' ? f : '',
                slash: s,
                input: str,
            };
        }
        return null;
    }
    static get support() {
        return regexp_support_1.default;
    }
    static get version() {
        return PackageJson.version;
    }
}
exports.zhRegExp = zhRegExp;
(function (zhRegExp) {
    zhRegExp.isRegExp = regexp_helper_1.default.isRegExp;
})(zhRegExp = exports.zhRegExp || (exports.zhRegExp = {}));
exports.parseRegularExpressionString = zhRegExp.parseRegularExpressionString;
exports.isRegExp = zhRegExp.isRegExp;
exports.create = zhRegExp.create.bind(zhRegExp);
exports.version = PackageJson.version;
exports.default = zhRegExp;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUlBLHFDQUEyRDtBQUMzRCw2REFBK0c7QUFDL0csaUVBQXlFO0FBQ3pFLG1EQUFzQztBQUN0QywrQ0FBdUM7QUFDdkMsaURBQW9FO0FBQ3BFLHVDQUErQjtBQUMvQiw4Q0FBOEM7QUE0QmpDLFFBQUEsY0FBYyxHQUFhLEVBQUUsQ0FBQztBQUUzQyxNQUFhLFFBQVMsU0FBUSxNQUFNO0lBZ0RuQyxZQUFZLEdBQUcsRUFBRSxLQUFLLEdBQUcsSUFBSSxFQUFFLFVBQTZCLEVBQUUsRUFBRSxHQUFHLElBQUk7UUFFdEUsSUFBSSxLQUFLLEtBQUssSUFBSSxJQUFJLE9BQU8sS0FBSyxJQUFJLFFBQVEsRUFDOUM7WUFDQyxPQUFPLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFhLENBQUM7WUFDL0MsS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDO1NBQzlCO1FBRUQsSUFBSSxPQUFPLE9BQU8sSUFBSSxRQUFRLEVBQzlCO1lBQ0MsT0FBTyxHQUFHO2dCQUNULElBQUksRUFBRSxPQUFPO2FBQ2IsQ0FBQztTQUNGO1FBRUQsSUFBSSxPQUFPLE9BQU8sQ0FBQyxLQUFLLElBQUksUUFBUSxFQUNwQztZQUNDLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDO1NBQ3RCO1FBRUQsSUFBSSxRQUFRLEdBQUcsT0FBTyxLQUFLLElBQUksUUFBUSxDQUFDO1FBRXhDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxJQUFJLENBQUMsT0FBTyxDQUFDLGlCQUFpQixJQUFJLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFDekU7WUFDQyxJQUFJLEVBQXNCLENBQUM7WUFFM0IsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sSUFBSSxrQkFBTyxDQUFDLE9BQU8sQ0FBQyxJ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QVcsV0FBVyxDQUFDLE9BQU8sQ0FBQztBQUVuRCxrQkFBZSxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyMDE4LzEvMzEvMDMxLlxuICovXG5cbmltcG9ydCB7IF93b3JkX3poX2NvcmUsIF93b3JkX3poX2NvcmUyIH0gZnJvbSAnLi9saWIvY29udic7XG5pbXBvcnQgUGFyc2VyRXZlbnRFbWl0dGVyLCB7IFBhcnNlckV2ZW50RW1pdHRlckV2ZW50LCBJUGFyc2VyRXZlbnRFbWl0dGVyTGlzdGVuZXIgfSBmcm9tICdyZWdleHAtcGFyc2VyLWV2ZW50JztcbmltcG9ydCB7IElBc3RUb1N0cmluZ09wdGlvbnMsIHBhcnNlUmVnRXhwIH0gZnJvbSAncmVnZXhwLXBhcnNlci1saXRlcmFsJztcbmltcG9ydCBfc3VwcG9ydCBmcm9tICdyZWdleHAtc3VwcG9ydCc7XG5pbXBvcnQgcmVnZXhwUmFuZ2UgZnJvbSAncmVnZXhwLXJhbmdlJztcbmltcG9ydCBSZWdleHBIZWxwZXIsIHsgaXNSZWdFeHAgYXMgX2lzUmVnRXhwIH0gZnJvbSAncmVnZXhwLWhlbHBlcic7XG5pbXBvcnQgQ2prQ29udiBmcm9tICdjamstY29udic7XG5pbXBvcnQgUGFja2FnZUpzb24gPSByZXF1aXJlKCcuL3BhY2thZ2UuanNvbicpXG5cbmV4cG9ydCB0eXBlIElPcHRpb25zID0ge1xuXHRza2lwPzogc3RyaW5nLFxuXHRkaXNhYmxlWmg/OiBib29sZWFuLFxuXHQvKipcblx0ICogZGlzYWJsZUxvY2FsUmFuZ2Ugb25seSB3b3JrIHdoZW4gZGlzYWJsZVpoIGlzIHRydWVcblx0ICovXG5cdGRpc2FibGVMb2NhbFJhbmdlPzogYm9vbGVhbixcblx0YWxsb3dMb2NhbFJhbmdlQXV0b1poPzogYm9vbGVhbixcblx0ZmxhZ3M/OiBzdHJpbmcsXG5cblx0LyoqXG5cdCAqIGFsbG93IHN0ciBpcyAvYS9nXG5cdCAqL1xuXHRwYXJzZVJlZ3VsYXJFeHByZXNzaW9uU3RyaW5nPzogYm9vbGVhbixcblxuXHRvbj86IHtcblx0XHRbayBpbiBrZXlvZiB0eXBlb2YgUGFyc2VyRXZlbnRFbWl0dGVyRXZlbnRdPzogSVBhcnNlckV2ZW50RW1pdHRlckxpc3RlbmVyPGFueT47XG5cdH0sXG5cblx0LyoqXG5cdCAqIGFsbG93IHNldCBgQ2prQ29udi56aFRhYmxlLmF1dG9gXG5cdCAqL1xuXHR6aFRhYmxlPzogKGNoYXI6IHN0cmluZykgPT4gc3RyaW5nW11cblxufSAmIElBc3RUb1N0cmluZ09wdGlvbnM7XG5cbmV4cG9ydCBjb25zdCBkZWZhdWx0T3B0aW9uczogSU9wdGlvbnMgPSB7fTtcblxuZXhwb3J0IGNsYXNzIHpoUmVnRXhwIGV4dGVuZHMgUmVnRXhwXG57XG5cdHB1YmxpYyBzb3VyY2U6IHN0cmluZztcblx0cHVibGljIGZsYWdzOiBzdHJpbmc7XG5cblx0cHVibGljIGRvdEFsbDogYm9vbGVhbjtcblxuXHRwdWJsaWMgaWdub3JlQ2FzZTogYm9vbGVhbjtcblx0cHVibGljIGdsb2JhbDogYm9vbGVhbjtcblx0cHVibGljIG11bHRpbGluZTogYm9vbGVhbjtcblx0cHVibGljIHN0aWNreTogYm9vbGVhbjtcblx0cHVibGljIHVuaWNvZGU6IGJvb2xlYW47XG5cblx0cHVibGljIGxhc3RJbmRleDogbnVtYmVyO1xuXG5cdC8qKlxuXHQgKiBUaGUgbm9uLXN0YW5kYXJkIGxlZnRDb250ZXh0IHByb3BlcnR5IGlzIGEgc3RhdGljIGFuZCByZWFkLW9ubHkgcHJvcGVydHkgb2YgcmVndWxhciBleHByZXNzaW9ucyB0aGF0IGNvbnRhaW5zIHRoZSBzdWJzdHJpbmcgcHJlY2VkaW5nIHRoZSBtb3N0IHJlY2VudCBtYXRjaC4gUmVnRXhwLiRgIGlzIGFuIGFsaWFzIGZvciB0aGlzIHByb3BlcnR5LlxuXHQgKlxuXHQgKiBAYWxpYXMgJGBcblx0ICovXG5cdHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgbGVmdENvbnRleHQ6IHN0cmluZztcblx0LyoqXG5cdCAqIFRoZSBub24tc3RhbmRhcmQgcmlnaHRDb250ZXh0IHByb3BlcnR5IGlzIGEgc3RhdGljIGFuZCByZWFkLW9ubHkgcHJvcGVydHkgb2YgcmVndWxhciBleHByZXNzaW9ucyB0aGF0IGNvbnRhaW5zIHRoZSBzdWJzdHJpbmcgZm9sbG93aW5nIHRoZSBtb3N0IHJlY2VudCBtYXRjaC4gUmVnRXhwLiQnIGlzIGFuIGFsaWFzIGZvciB0aGlzIHByb3BlcnR5LlxuXHQgKlxuXHQgKiBAYWxpYXMgJCdcblx0ICovXG5cdHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgcmlnaHRDb250ZXh0OiBzdHJpbmc7XG5cdC8qKlxuXHQgKiBUaGUgbm9uLXN0YW5kYXJkIGxhc3RQYXJlbiBwcm9wZXJ0eSBpcyBhIHN0YXRpYyBhbmQgcmVhZC1vbmx5IHByb3BlcnR5IG9mIHJlZ3VsYXIgZXhwcmVzc2lvbnMgdGhhdCBjb250YWlucyB0aGUgbGFzdCBwYXJlbnRoZXNpemVkIHN1YnN0cmluZyBtYXRjaCwgaWYgYW55LiBSZWdFeHAuJCsgaXMgYW4gYWxpYXMgZm9yIHRoaXMgcHJvcGVydHkuXG5cdCAqXG5cdCAqIEBhbGlhcyAkK1xuXHQgKi9cblx0cHVibGljIHN0YXRpYyByZWFkb25seSBsYXN0UGFyZW46IHN0cmluZztcblx0LyoqXG5cdCAqIFRoZSBub24tc3RhbmRhcmQgbGFzdE1hdGNoIHByb3BlcnR5IGlzIGEgc3RhdGljIGFuZCByZWFkLW9ubHkgcHJvcGVydHkgb2YgcmVndWxhciBleHByZXNzaW9ucyB0aGF0IGNvbnRhaW5zIHRoZSBsYXN0IG1hdGNoZWQgY2hhcmFjdGVycy4gUmVnRXhwLiQmIGlzIGFuIGFsaWFzIGZvciB0aGlzIHByb3BlcnR5LlxuXHQgKlxuXHQgKiBAYWxpYXMgJCZcblx0ICovXG5cdHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgbGFzdE1hdGNoOiBzdHJpbmc7XG5cdC8qKlxuXHQgKiBUaGUgbm9uLXN0YW5kYXJkIGlucHV0IHByb3BlcnR5IGlzIGEgc3RhdGljIHByb3BlcnR5IG9mIHJlZ3VsYXIgZXhwcmVzc2lvbnMgdGhhdCBjb250YWlucyB0aGUgc3RyaW5nIGFnYWluc3Qgd2hpY2ggYSByZWd1bGFyIGV4cHJlc3Npb24gaXMgbWF0Y2hlZC4gUmVnRXhwLiRfIGlzIGFuIGFsaWFzIGZvciB0aGlzIHByb3BlcnR5LlxuXHQgKlxuXHQgKiBAYWxpYXMgJF9cblx0ICovXG5cdHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgaW5wdXQ6IHN0cmluZztcblxuXHRjb25zdHJ1Y3RvcihzdHI6IHN0cmluZyB8IFJlZ0V4cCwgZmxhZ3M/OiBzdHJpbmcsIG9wdGlvbnM/OiBJT3B0aW9ucyB8IHN0cmluZywgLi4uYXJndilcblx0Y29uc3RydWN0b3Ioc3RyOiBzdHJpbmcgfCBSZWdFeHAsIG9wdGlvbnM/OiBJT3B0aW9ucywgLi4uYXJndilcblx0Y29uc3RydWN0b3Ioc3RyLCBmbGFncyA9IG51bGwsIG9wdGlvbnM6IElPcHRpb25zIHwgc3RyaW5nID0ge30sIC4uLmFyZ3YpXG5cdHtcblx0XHRpZiAoZmxhZ3MgIT09IG51bGwgJiYgdHlwZW9mIGZsYWdzID09ICdvYmplY3QnKVxuXHRcdHtcblx0XHRcdG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBmbGFncykgYXMgSU9wdGlvbnM7XG5cdFx0XHRmbGFncyA9IG9wdGlvbnMuZmxhZ3MgfHwgbnVsbDtcblx0XHR9XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnMgPT0gJ3N0cmluZycpXG5cdFx0e1xuXHRcdFx0b3B0aW9ucyA9IHtcblx0XHRcdFx0c2tpcDogb3B0aW9ucyxcblx0XHRcdH07XG5cdFx0fVxuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zLmZsYWdzID09ICdzdHJpbmcnKVxuXHRcdHtcblx0XHRcdGZsYWdzID0gb3B0aW9ucy5mbGFncztcblx0XHR9XG5cblx0XHRsZXQgaGFzRmxhZ3MgPSB0eXBlb2YgZmxhZ3MgPT0gJ3N0cmluZyc7XG5cblx0XHRpZiAoMSAmJiAoIW9wdGlvbnMuZGlzYWJsZVpoIHx8ICFvcHRpb25zLmRpc2FibGVMb2NhbFJhbmdlIHx8IG9wdGlvbnMub24pKVxuXHRcdHtcblx0XHRcdGxldCBldjogUGFyc2VyRXZlbnRFbWl0dGVyO1xuXG5cdFx0XHRjb25zdCB6aFRhYmxlID0gb3B0aW9ucy56aFRhYmxlIHx8IENqa0NvbnYuemhUYWJsZS5hdXRvXG5cblx0XHRcdGlmIChzdHIgaW5zdGFuY2VvZiBSZWdFeHApXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBhc3QgPSBwYXJzZVJlZ0V4cChzdHIudG9TdHJpbmcoKSk7XG5cdFx0XHRcdGV2ID0gbmV3IFBhcnNlckV2ZW50RW1pdHRlcihhc3QpO1xuXHRcdFx0fVxuXHRcdFx0ZWxzZVxuXHRcdFx0e1xuXHRcdFx0XHRpZiAob3B0aW9ucy5wYXJzZVJlZ3VsYXJFeHByZXNzaW9uU3RyaW5nICYmIHR5cGVvZiBzdHIgPT0gJ3N0cmluZycpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRsZXQgbSA9IHpoUmVnRXhwLnBhcnNlUmVndWxhckV4cHJlc3Npb25TdHJpbmcoc3RyKTtcblx0XHRcdFx0XHRpZiAobSlcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRzdHIgPSBtLnNvdXJjZTtcblx0XHRcdFx0XHRcdGZsYWdzID0gaGFzRmxhZ3MgPyBmbGFncyA6IG0uZmxhZ3M7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cblx0XHRcdFx0ZXYgPSBQYXJzZXJFdmVudEVtaXR0ZXIuY3JlYXRlKHN0ciwgZmxhZ3MgfHwgJycpO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoIW9wdGlvbnMuZGlzYWJsZVpoKVxuXHRcdFx0e1xuXHRcdFx0XHRldi5vbihQYXJzZXJFdmVudEVtaXR0ZXJFdmVudC5kZWZhdWx0LCBmdW5jdGlvbiAoYXN0KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0YXN0Lm9sZF9yYXcgPSBhc3Qub2xkX3JhdyB8fCBhc3QucmF3O1xuXHRcdFx0XHRcdGFzdC5yYXcgPSBfd29yZF96aF9jb3JlKGFzdC5yYXcsIChvcHRpb25zIGFzIElPcHRpb25zKS5za2lwLCB6aFRhYmxlKTtcblx0XHRcdFx0XHRldi5lbWl0KFBhcnNlckV2ZW50RW1pdHRlckV2ZW50LmNoYW5nZSwgYXN0KTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cblx0XHRcdGlmICghb3B0aW9ucy5kaXNhYmxlTG9jYWxSYW5nZSlcblx0XHRcdHtcblx0XHRcdFx0ZXYub24oUGFyc2VyRXZlbnRFbWl0dGVyRXZlbnQuY2xhc3NfcmFuZ2UsIGZ1bmN0aW9uIChhc3QsIC4uLmFyZ3YpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRsZXQgcyA9IGFzdC5taW4ucmF3O1xuXHRcdFx0XHRcdGxldCBlID0gYXN0Lm1heC5yYXc7XG5cblx0XHRcdFx0XHRsZXQgcmV0ID0gcmVnZXhwUmFuZ2UocywgZSwge1xuXHRcdFx0XHRcdFx0Y3JlYXRlUmVnRXhwU3RyaW5nOiB0cnVlLFxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdGlmIChyZXQpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0aWYgKChvcHRpb25zIGFzIElPcHRpb25zKS5hbGxvd0xvY2FsUmFuZ2VBdXRvWmgpXG5cdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdHJldCA9IF93b3JkX3poX2NvcmUyKHJldCwgKG9wdGlvbnMgYXMgSU9wdGlvbnMpLnNraXAsIHpoVGFibGUpO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRhc3Qub2xkX3JhdyA9IGFzdC5vbGRfcmF3IHx8IGFzdC5yYXc7XG5cdFx0XHRcdFx0XHRhc3QucmF3ID0gcmV0O1xuXG5cdFx0XHRcdFx0XHRldi5lbWl0KFBhcnNlckV2ZW50RW1pdHRlckV2ZW50LmNoYW5nZSwgYXN0KTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHQvKlxuXHRcdFx0XHRcdGZvciAobGV0IHIgb2YgbG9jYWxfcmFuZ2UpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0bGV0IGkgPSByLmluZGV4T2Yocyk7XG5cdFx0XHRcdFx0XHRsZXQgaiA9IHIuaW5kZXhPZihlLCBpKTtcblxuXHRcdFx0XHRcdFx0aWYgKGkgIT09IC0xICYmIGogIT09IC0xKVxuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRhc3Qub2xkX3JhdyA9IGFzdC5vbGRfcmF3IHx8IGFzdC5yYXc7XG5cdFx0XHRcdFx0XHRcdGFzdC5yYXcgPSByLnNsaWNlKGksIGogKyAxKS5qb2luKCcnKTtcblxuXHRcdFx0XHRcdFx0XHRldi5lbWl0KFBhcnNlckV2ZW50RW1pdHRlckV2ZW50LmNoYW5nZSwgYXN0KTtcblx0XHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdCovXG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAob3B0aW9ucy5vbilcblx0XHRcdHtcblx0XHRcdFx0T2JqZWN0XG5cdFx0XHRcdFx0LmtleXMob3B0aW9ucy5vbilcblx0XHRcdFx0XHQuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0XHRcdFx0ZXYub24oZXZlbnQsIChvcHRpb25zIGFzIElPcHRpb25zKS5vbltldmVudF0pXG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0O1xuXHRcdFx0fVxuXG5cdFx0XHRldi5yZXN1bWUoKTtcblxuXHRcdFx0Ly9vcHRpb25zLnNvcnRDbGFzcyA9IHRydWU7XG5cblx0XHRcdHN0ciA9IGV2LmdldFNvdXJjZSghIW9wdGlvbnMuZGVidWdDaGFuZ2VkXG5cdFx0XHRcdHx8ICFvcHRpb25zLm5vVW5pcXVlQ2xhc3Ncblx0XHRcdFx0fHwgb3B0aW9ucy5zb3J0Q2xhc3Ncblx0XHRcdFx0LCBvcHRpb25zKTtcblx0XHRcdGZsYWdzID0gaGFzRmxhZ3MgPyBmbGFncyA6IGV2LmZsYWdzO1xuXHRcdH1cblx0XHRlbHNlXG5cdFx0e1xuXHRcdFx0aWYgKG9wdGlvbnMucGFyc2VSZWd1bGFyRXhwcmVzc2lvblN0cmluZyAmJiB0eXBlb2Ygc3RyID09ICdzdHJpbmcnKVxuXHRcdFx0e1xuXHRcdFx0XHRsZXQgbSA9IHpoUmVnRXhwLnBhcnNlUmVndWxhckV4cHJlc3Npb25TdHJpbmcoc3RyKTtcblx0XHRcdFx0aWYgKG0pXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRzdHIgPSBuZXcgUmVnRXhwKG0uc291cmNlLCBtLmZsYWdzKTtcblx0XHRcdFx0XHRmbGFncyA9IGhhc0ZsYWdzID8gZmxhZ3MgOiBzdHIuZmxhZ3M7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHRcdGVsc2UgaWYgKHN0ciBpbnN0YW5jZW9mIFJlZ0V4cClcblx0XHRcdHtcblx0XHRcdFx0c3RyID0gc3RyLnNvdXJjZTtcblx0XHRcdFx0ZmxhZ3MgPSBoYXNGbGFncyA/IGZsYWdzIDogc3RyLmZsYWdzO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHN1cGVyKHN0ciwgZmxhZ3MgfHwgJycpO1xuXG5cdFx0Lypcblx0XHRpZiAob3B0aW9ucy5wYXJzZVJlZ3VsYXJFeHByZXNzaW9uU3RyaW5nICYmIHR5cGVvZiBzdHIgPT0gJ3N0cmluZycpXG5cdFx0e1xuXHRcdFx0bGV0IG0gPSB6aFJlZ0V4cC5wYXJzZVJlZ3VsYXJFeHByZXNzaW9uU3RyaW5nKHN0cik7XG5cdFx0XHRpZiAobSlcblx0XHRcdHtcblx0XHRcdFx0c3RyID0gbmV3IFJlZ0V4cChtLnNvdXJjZSwgbS5mbGFncyk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0bGV0IGhhc0ZsYWdzID0gdHlwZW9mIGZsYWdzID09ICdzdHJpbmcnO1xuXG5cdFx0bGV0IHJzLCBmO1xuXG5cdFx0aWYgKCFvcHRpb25zLmRpc2FibGVaaClcblx0XHR7XG5cdFx0XHRbcnMsIGZdID0gbGliLl93b3JkX3poKHN0ciwgbnVsbCwgZmxhZ3MgfHwgc3RyLmZsYWdzKTtcblx0XHR9XG5cdFx0ZWxzZSBpZiAoIW9wdGlvbnMuZGlzYWJsZUxvY2FsUmFuZ2UpXG5cdFx0e1xuXHRcdFx0cnMgPSBsaWIucmVwbGFjZV9saXRlcmFsKHN0ciwgZnVuY3Rpb24gKHRleHQ6IHN0cmluZylcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIHRleHQ7XG5cdFx0XHR9KTtcblx0XHR9XG5cblx0XHRsZXQgYm9vbCA9IChycyBpbnN0YW5jZW9mIFJlZ0V4cCk7XG5cblx0XHRpZiAoaGFzRmxhZ3MpXG5cdFx0e1xuXHRcdFx0ZiA9IGZsYWdzO1xuXHRcdH1cblx0XHRlbHNlXG5cdFx0e1xuXHRcdFx0ZiA9IGYgfHwgZmxhZ3MgfHwgcnMuZmxhZ3MgfHwgJyc7XG5cdFx0fVxuXG5cdFx0aWYgKCFib29sKVxuXHRcdHtcblx0XHRcdHN1cGVyKHJzLCBmKTtcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdHN1cGVyKHJzLnNvdXJjZSwgZik7XG5cdFx0fVxuXHRcdCovXG5cdH1cblxuXHRzdGF0aWMgY3JlYXRlPFQgPSB6aFJlZ0V4cD4oc3RyOiBzdHJpbmcgfCBSZWdFeHAsIGZsYWdzPzogc3RyaW5nLCBvcHRpb25zPzogSU9wdGlvbnMgfCBzdHJpbmcpOiBUXG5cdHN0YXRpYyBjcmVhdGU8VCA9IHpoUmVnRXhwPihzdHI6IHN0cmluZyB8IFJlZ0V4cCwgb3B0aW9ucz86IElPcHRpb25zKTogVFxuXHRzdGF0aWMgY3JlYXRlPFQgPSB6aFJlZ0V4cD4oc3RyLCBmbGFncyA9IG51bGwsIHNraXA/LCAuLi5hcmd2KVxuXHR7XG5cdFx0cmV0dXJuIG5ldyB0aGlzKHN0ciwgZmxhZ3MsIHNraXAsIC4uLmFyZ3YpO1xuXHR9XG5cblx0Z2V0U3RhdGljPFQgPSB0eXBlb2YgemhSZWdFeHA+KCk6IFRcblx0e1xuXHRcdHJldHVybiBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcyk7XG5cdH1cblxuXHQvKipcblx0ICogQHRvZG9cblx0ICovXG5cdHRvUmVndWxhckV4cHJlc3Npb25TdHJpbmcoKVxuXHR7XG5cdFx0cmV0dXJuIHRoaXMudG9TdHJpbmcoKTtcblx0XHQvL3JldHVybiBgLyR7dGhpcy5zb3VyY2V9LyR7dGhpcy5mbGFnc31gO1xuXHR9XG5cblx0c3RhdGljIHBhcnNlUmVndWxhckV4cHJlc3Npb25TdHJpbmcoc3RyOiBzdHJpbmcpXG5cdHtcblx0XHRsZXQgbSA9IC9eKFtcXC8jJCVdKSguKz8pXFwxKFthLXpdKikkLy5leGVjKHN0cik7XG5cdFx0aWYgKG0pXG5cdFx0e1xuXHRcdFx0bGV0IFtzLCBkLCByLCBmXSA9IG07XG5cblx0XHRcdHJldHVybiB7XG5cdFx0XHRcdHNvdXJjZTogdHlwZW9mIHIgIT09ICd1bmRlZmluZWQnID8gciA6ICcnLFxuXHRcdFx0XHRmbGFnczogdHlwZW9mIGYgIT09ICd1bmRlZmluZWQnID8gZiA6ICcnLFxuXHRcdFx0XHRzbGFzaDogcyxcblx0XHRcdFx0aW5wdXQ6IHN0cixcblx0XHRcdH07XG5cdFx0fVxuXG5cdFx0cmV0dXJuIG51bGw7XG5cdH1cblxuXHRzdGF0aWMgZ2V0IHN1cHBvcnQoKTogdHlwZW9mIF9zdXBwb3J0XG5cdHtcblx0XHRyZXR1cm4gX3N1cHBvcnQ7XG5cdH1cblxuXHRzdGF0aWMgZ2V0IHZlcnNpb24oKTogc3RyaW5nXG5cdHtcblx0XHRyZXR1cm4gUGFja2FnZUpzb24udmVyc2lvblxuXHR9XG59XG5cbmV4cG9ydCBuYW1lc3BhY2UgemhSZWdFeHBcbntcblx0ZXhwb3J0IGltcG9ydCBpc1JlZ0V4cCA9IFJlZ2V4cEhlbHBlci5pc1JlZ0V4cDtcbn1cblxuZXhwb3J0IGNvbnN0IHBhcnNlUmVndWxhckV4cHJlc3Npb25TdHJpbmcgPSB6aFJlZ0V4cC5wYXJzZVJlZ3VsYXJFeHByZXNzaW9uU3RyaW5nO1xuZXhwb3J0IGNvbnN0IGlzUmVnRXhwID0gemhSZWdFeHAuaXNSZWdFeHA7XG5leHBvcnQgY29uc3QgY3JlYXRlID0gemhSZWdFeHAuY3JlYXRlLmJpbmQoemhSZWdFeHApIGFzIHR5cGVvZiB6aFJlZ0V4cC5jcmVhdGU7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUFwaTxUID0gemhSZWdFeHA+XG57XG5cdChzdHI6IHN0cmluZyB8IFJlZ0V4cCwgZmxhZ3M/OiBzdHJpbmcsIG9wdGlvbnM/OiBJT3B0aW9ucyB8IHN0cmluZyk6IFQsXG5cdChzdHI6IHN0cmluZyB8IFJlZ0V4cCwgb3B0aW9ucz86IElPcHRpb25zKTogVCxcbn1cblxuZXhwb3J0IGNvbnN0IHZlcnNpb246IHN0cmluZyA9IFBhY2thZ2VKc29uLnZlcnNpb247XG5cbmV4cG9ydCBkZWZhdWx0IHpoUmVnRXhwO1xuIl19